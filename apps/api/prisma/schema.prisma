generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// ============================================================
// AUTH / BILLING
// ============================================================

model Account {
  id         String        @id @default(uuid())
  name       String        @db.VarChar(255)
  phone      String?       @db.VarChar(20)
  status     AccountStatus @default(ACTIVE)
  balance    BigInt        @default(0)
  daily_fee  BigInt?       // NULL = global default ishlatiladi
  ai_monthly_limit_usd Decimal? @db.Decimal(10, 2) // NULL = unlimited, e.g. 5.00
  created_at DateTime      @default(now()) @db.Timestamptz

  users              User[]
  transactions       Transaction[]
  audit_events       AuditEvent[]
  category_runs      CategoryRun[]
  tracked_products   TrackedProduct[]
  alert_rules        AlertRule[]
  price_searches     ExternalPriceSearch[]
  cargo_calculations CargoCalculation[]
  external_search_jobs   ExternalSearchJob[]
  competitor_trackings   CompetitorTracking[]
  referrals_from         Referral[]  @relation("referrer")
  referrals_to           Referral[]  @relation("referred")
  api_keys               ApiKey[]
  consultant_sessions    Consultation[] @relation("consultant_sessions")
  client_sessions        Consultation[] @relation("client_sessions")
  price_tests            PriceTest[]
  product_checklists     ProductChecklist[]
  ad_campaigns           AdCampaign[]
  team_invites           TeamInvite[]
  custom_reports         CustomReport[]
  shared_watchlists      SharedWatchlist[]
  community_insights     CommunityInsight[]
  notifications          Notification[]
  feedback_tickets       FeedbackTicket[]
  user_activities        UserActivity[]

  @@map("accounts")
}

enum AccountStatus {
  ACTIVE
  PAYMENT_DUE
  SUSPENDED
}

model User {
  id            String   @id @default(uuid())
  account_id    String
  email         String   @unique @db.VarChar(255)
  password_hash String   @db.VarChar(255)
  role          UserRole @default(USER)
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now()) @db.Timestamptz

  account      Account         @relation(fields: [account_id], references: [id], onDelete: Cascade)
  audit_events AuditEvent[]
  activities   UserActivity[]
  sessions     UserSession[]
  feedback_tickets  FeedbackTicket[]
  feedback_messages FeedbackMessage[]

  @@index([account_id])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
  USER
}

model Transaction {
  id             String          @id @default(uuid())
  account_id     String
  type           TransactionType
  amount         BigInt
  balance_before BigInt
  balance_after  BigInt
  description    String?         @db.Text
  created_at     DateTime        @default(now()) @db.Timestamptz

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@map("transactions")
}

enum TransactionType {
  CHARGE
  DEPOSIT
  REFUND
}

model AuditEvent {
  id         String   @id @default(uuid())
  account_id String?
  user_id    String?
  action     String   @db.VarChar(100)
  old_value  Json?
  new_value  Json?
  created_at DateTime @default(now()) @db.Timestamptz

  account Account? @relation(fields: [account_id], references: [id], onDelete: SetNull)
  user    User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([account_id])
  @@index([created_at])
  @@map("audit_events")
}

// ============================================================
// SYSTEM SETTINGS
// ============================================================

model SystemSetting {
  key        String   @id @db.VarChar(100)
  value      String   @db.Text
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz

  @@map("system_settings")
}

// ============================================================
// UZUM DATA
// ============================================================

model Shop {
  id               BigInt    @id
  title            String?   @db.VarChar(500)
  rating           Decimal?  @db.Decimal(3, 2)
  orders_quantity  BigInt?
  registered_at    DateTime? @db.Timestamptz
  created_at       DateTime  @default(now()) @db.Timestamptz
  updated_at       DateTime  @updatedAt @db.Timestamptz

  products Product[]

  @@map("shops")
}

model Product {
  id                BigInt                      @id
  sku_group_id      BigInt?
  shop_id           BigInt?
  title             String                      @db.Text
  category_id       BigInt?
  rating            Decimal?                    @db.Decimal(3, 2)
  feedback_quantity Int?                        @default(0)
  orders_quantity   BigInt?                     @default(0)
  total_available_amount BigInt?
  photo_url         String?                     @db.Text
  is_active         Boolean                     @default(true)
  // embedding      Unsupported("vector(1536)")? — disabled: Railway Postgres lacks pgvector
  created_at        DateTime                    @default(now()) @db.Timestamptz
  updated_at        DateTime                    @updatedAt @db.Timestamptz

  shop              Shop?               @relation(fields: [shop_id], references: [id])
  skus              Sku[]
  snapshots         ProductSnapshot[]
  tracked_by        TrackedProduct[]
  category_winners  CategoryWinner[]
  alert_rules       AlertRule[]
  alert_events      AlertEvent[]
  ai_attributes     ProductAiAttribute?
  ai_explanations   ProductAiExplanation[]
  external_search_jobs ExternalSearchJob[]
  competitors_from     CompetitorTracking[] @relation("product_competitors")
  competitors_of       CompetitorTracking[] @relation("competitor_of")
  price_tests          PriceTest[]

  @@index([category_id, is_active])
  @@map("products")
}

model Sku {
  id           BigInt   @id
  product_id   BigInt
  min_sell_price BigInt?
  min_full_price BigInt?
  stock_type   String?  @db.VarChar(10)
  is_available Boolean  @default(true)
  created_at   DateTime @default(now()) @db.Timestamptz

  product      Product       @relation(fields: [product_id], references: [id], onDelete: Cascade)
  sku_snapshots SkuSnapshot[]

  @@map("skus")
}

model ProductSnapshot {
  id                   String   @id @default(uuid())
  product_id           BigInt
  orders_quantity      BigInt?
  weekly_bought        Int?
  weekly_bought_source String?  @db.VarChar(20) // 'scraped' | 'calculated' | 'stored_scraped'
  rating               Decimal? @db.Decimal(3, 2)
  feedback_quantity    Int?
  score                Decimal? @db.Decimal(8, 4)
  snapshot_at          DateTime @default(now()) @db.Timestamptz

  product         Product                @relation(fields: [product_id], references: [id], onDelete: Cascade)
  ai_explanations ProductAiExplanation[]

  @@index([product_id, snapshot_at])
  @@map("product_snapshots")
}

model SkuSnapshot {
  id               String   @id @default(uuid())
  sku_id           BigInt
  sell_price       BigInt?
  full_price       BigInt?
  discount_percent Int?
  stock_type       String?  @db.VarChar(10)
  snapshot_at      DateTime @default(now()) @db.Timestamptz

  sku Sku @relation(fields: [sku_id], references: [id], onDelete: Cascade)

  @@map("sku_snapshots")
}

// ============================================================
// DISCOVERY
// ============================================================

model CategoryRun {
  id             String          @id @default(uuid())
  account_id     String
  category_id    BigInt
  category_name  String?         @db.VarChar(255)
  status         CategoryRunStatus @default(PENDING)
  total_products Int?
  processed      Int             @default(0)
  started_at     DateTime?       @db.Timestamptz
  finished_at    DateTime?       @db.Timestamptz
  created_at     DateTime        @default(now()) @db.Timestamptz

  account  Account          @relation(fields: [account_id], references: [id], onDelete: Cascade)
  winners  CategoryWinner[]

  @@index([account_id])
  @@index([created_at])
  @@map("category_runs")
}

enum CategoryRunStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

model CategoryWinner {
  id              String   @id @default(uuid())
  run_id          String
  product_id      BigInt
  score           Decimal? @db.Decimal(8, 4)
  rank            Int?
  weekly_bought   Int?
  orders_quantity BigInt?
  sell_price      BigInt?
  created_at      DateTime @default(now()) @db.Timestamptz

  run     CategoryRun @relation(fields: [run_id], references: [id], onDelete: Cascade)
  product Product     @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@map("category_winners")
}

model TrackedProduct {
  id             String    @id @default(uuid())
  account_id     String
  product_id     BigInt
  is_active      Boolean   @default(true)
  next_scrape_at DateTime? @db.Timestamptz
  last_scraped_at DateTime? @db.Timestamptz
  created_at     DateTime  @default(now()) @db.Timestamptz

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([account_id, product_id])
  @@index([created_at])
  @@index([next_scrape_at])
  @@map("tracked_products")
}

// ============================================================
// ALERTS
// ============================================================

model AlertRule {
  id         String    @id @default(uuid())
  account_id String
  product_id BigInt
  rule_type  AlertType
  threshold  Decimal?  @db.Decimal(10, 2)
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now()) @db.Timestamptz

  account Account      @relation(fields: [account_id], references: [id], onDelete: Cascade)
  product Product      @relation(fields: [product_id], references: [id], onDelete: Cascade)
  events  AlertEvent[]

  @@index([account_id])
  @@map("alert_rules")
}

enum AlertType {
  PRICE_DROP
  STOCK_LOW
  SCORE_SPIKE
}

model AlertEvent {
  id           String   @id @default(uuid())
  rule_id      String
  product_id   BigInt
  message      String?  @db.Text
  triggered_at DateTime @default(now()) @db.Timestamptz

  rule    AlertRule @relation(fields: [rule_id], references: [id], onDelete: Cascade)
  product Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@map("alert_events")
}

// ============================================================
// AI TABLES
// ============================================================

model ProductAiAttribute {
  id         String   @id @default(uuid())
  product_id BigInt   @unique
  brand      String?  @db.VarChar(255)
  model      String?  @db.VarChar(255)
  type       String?  @db.VarChar(255)
  color      String?  @db.VarChar(255)
  raw_json   Json?
  created_at DateTime @default(now()) @db.Timestamptz

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@map("product_ai_attributes")
}

// ============================================================
// SOURCING
// ============================================================

model CurrencyRate {
  id         String   @id @default(uuid())
  from_code  String   @db.VarChar(10) // USD, CNY, EUR
  to_code    String   @db.VarChar(10) // UZS
  rate       Decimal  @db.Decimal(20, 4)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz

  @@unique([from_code, to_code])
  @@map("currency_rates")
}

model CargoProvider {
  id            String   @id @default(uuid())
  name          String   @db.VarChar(255)
  origin        String   @db.VarChar(10) // CN, EU
  destination   String   @db.VarChar(10) // UZ
  method        String   @db.VarChar(50) // AVIA, CARGO, RAIL, AUTO, TURKEY
  rate_per_kg   Decimal  @db.Decimal(10, 2) // USD per kg
  delivery_days Int
  min_weight_kg Decimal? @db.Decimal(10, 2)
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now()) @db.Timestamptz

  calculations CargoCalculation[]

  @@map("cargo_providers")
}

model ExternalPriceSearch {
  id         String   @id @default(uuid())
  account_id String
  query      String   @db.VarChar(500)
  source     String   @db.VarChar(50) // ALIBABA, ALIEXPRESS, SERPAPI
  results    Json?
  created_at DateTime @default(now()) @db.Timestamptz

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@map("external_price_searches")
}

model CargoCalculation {
  id              String   @id @default(uuid())
  account_id      String
  provider_id     String?
  job_id          String?
  result_id       String?
  item_name       String?  @db.VarChar(500)
  item_cost_usd   Decimal  @db.Decimal(20, 2)
  weight_kg       Decimal  @db.Decimal(10, 2)
  quantity        Int
  customs_rate    Decimal  @db.Decimal(5, 4) // 0.10 = 10%
  vat_rate        Decimal  @db.Decimal(5, 4) // 0.12 = 12%
  cargo_cost_usd  Decimal  @db.Decimal(20, 2)
  customs_usd     Decimal  @db.Decimal(20, 2)
  vat_usd         Decimal  @db.Decimal(20, 2)
  landed_cost_usd Decimal  @db.Decimal(20, 2)
  landed_cost_uzs Decimal  @db.Decimal(20, 2)
  sell_price_uzs  Decimal? @db.Decimal(20, 2)
  gross_margin    Decimal? @db.Decimal(8, 4)
  roi             Decimal? @db.Decimal(8, 4)
  usd_rate        Decimal  @db.Decimal(20, 4)
  created_at      DateTime @default(now()) @db.Timestamptz

  account  Account                @relation(fields: [account_id], references: [id], onDelete: Cascade)
  provider CargoProvider?         @relation(fields: [provider_id], references: [id])
  job      ExternalSearchJob?     @relation(fields: [job_id], references: [id], onDelete: Cascade)
  result   ExternalSearchResult?  @relation(fields: [result_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@map("cargo_calculations")
}

// ============================================================
// EXTERNAL SOURCING
// ============================================================

model ExternalPlatform {
  id         String   @id @default(uuid())
  code       String   @unique @db.VarChar(50)  // "alibaba", "1688", "taobao", "aliexpress", "amazon_de"
  name       String   @db.VarChar(100)
  country    String   @db.VarChar(10)           // "CN", "DE", "US"
  base_url   String   @db.VarChar(255)
  is_active  Boolean  @default(true)
  api_type   String   @db.VarChar(30)           // "serpapi", "affiliate", "playwright", "direct"
  created_at DateTime @default(now()) @db.Timestamptz

  search_results ExternalSearchResult[]

  @@map("external_platforms")
}

model ExternalSearchJob {
  id          String               @id @default(uuid())
  account_id  String
  product_id  BigInt
  query       String               @db.Text
  status      ExternalSearchStatus @default(PENDING)
  platforms   String[]
  created_at  DateTime             @default(now()) @db.Timestamptz
  finished_at DateTime?            @db.Timestamptz

  account            Account                @relation(fields: [account_id], references: [id], onDelete: Cascade)
  product            Product                @relation(fields: [product_id], references: [id], onDelete: Cascade)
  results            ExternalSearchResult[]
  cargo_calculations CargoCalculation[]

  @@index([account_id])
  @@map("external_search_jobs")
}

enum ExternalSearchStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

model ExternalSearchResult {
  id             String   @id @default(uuid())
  job_id         String
  platform_id    String
  external_id    String?  @db.VarChar(255)
  title          String   @db.Text
  price_usd      Decimal  @db.Decimal(12, 2)
  price_local    Decimal? @db.Decimal(12, 2)
  currency       String   @db.VarChar(5)
  url            String   @db.Text
  image_url      String?  @db.Text
  seller_name    String?  @db.VarChar(255)
  seller_rating  Decimal? @db.Decimal(3, 2)
  min_order_qty  Int?     @default(1)
  shipping_days  Int?
  ai_match_score Decimal? @db.Decimal(4, 3) // 0.000 - 1.000
  ai_notes       String?  @db.Text
  rank           Int?
  created_at     DateTime @default(now()) @db.Timestamptz

  job                ExternalSearchJob  @relation(fields: [job_id], references: [id], onDelete: Cascade)
  platform           ExternalPlatform   @relation(fields: [platform_id], references: [id])
  cargo_calculations CargoCalculation[]

  @@map("external_search_results")
}

model ProductAiExplanation {
  id          String   @id @default(uuid())
  product_id  BigInt
  snapshot_id String?
  explanation String?  @db.Text
  created_at  DateTime @default(now()) @db.Timestamptz

  product  Product          @relation(fields: [product_id], references: [id], onDelete: Cascade)
  snapshot ProductSnapshot? @relation(fields: [snapshot_id], references: [id], onDelete: Cascade)

  @@map("product_ai_explanations")
}

// ============================================================
// COMPETITOR TRACKING
// ============================================================

model CompetitorTracking {
  id                    String   @id @default(uuid())
  account_id            String
  product_id            BigInt
  competitor_product_id BigInt
  is_active             Boolean  @default(true)
  created_at            DateTime @default(now()) @db.Timestamptz

  account    Account @relation(fields: [account_id], references: [id], onDelete: Cascade)
  product    Product @relation("product_competitors", fields: [product_id], references: [id], onDelete: Cascade)
  competitor Product @relation("competitor_of", fields: [competitor_product_id], references: [id], onDelete: Cascade)
  snapshots  CompetitorPriceSnapshot[]

  @@unique([account_id, product_id, competitor_product_id])
  @@map("competitor_trackings")
}

model CompetitorPriceSnapshot {
  id           String   @id @default(uuid())
  tracking_id  String
  sell_price   BigInt?
  full_price   BigInt?
  discount_pct Int?     @default(0)
  snapshot_at  DateTime @default(now()) @db.Timestamptz

  tracking CompetitorTracking @relation(fields: [tracking_id], references: [id], onDelete: Cascade)

  @@index([tracking_id, snapshot_at])
  @@map("competitor_price_snapshots")
}

// ============================================================
// SEASONAL TRENDS
// ============================================================

model SeasonalTrend {
  id              String   @id @default(uuid())
  category_id     BigInt?
  season_name     String   @db.VarChar(100)
  season_start    Int      // month (1-12)
  season_end      Int      // month (1-12)
  avg_score_boost Decimal? @db.Decimal(4, 2)
  peak_week       Int?
  created_at      DateTime @default(now()) @db.Timestamptz

  @@map("seasonal_trends")
}

// ============================================================
// REFERRAL SYSTEM
// ============================================================

model Referral {
  id                  String         @id @default(uuid())
  referrer_account_id String
  referred_account_id String?
  code                String         @unique @db.VarChar(20)
  status              ReferralStatus @default(PENDING)
  reward_days         Int            @default(7)
  credited_at         DateTime?      @db.Timestamptz
  created_at          DateTime       @default(now()) @db.Timestamptz

  referrer Account  @relation("referrer", fields: [referrer_account_id], references: [id], onDelete: Cascade)
  referred Account? @relation("referred", fields: [referred_account_id], references: [id], onDelete: SetNull)

  @@index([referrer_account_id])
  @@map("referrals")
}

enum ReferralStatus {
  PENDING
  ACTIVE
  EXPIRED
}

// ============================================================
// API KEYS
// ============================================================

model ApiKey {
  id             String    @id @default(uuid())
  account_id     String
  name           String    @db.VarChar(100)
  key_prefix     String    @db.VarChar(12)
  key_hash       String    @db.VarChar(64)
  daily_limit    Int       @default(1000)
  requests_today Int       @default(0)
  last_used_at   DateTime? @db.Timestamptz
  last_reset_at  DateTime  @default(now()) @db.Timestamptz
  is_active      Boolean   @default(true)
  created_at     DateTime  @default(now()) @db.Timestamptz

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@map("api_keys")
}

// ============================================================
// CONSULTATIONS (Feature 15 — Konsultatsiya Marketplace)
// ============================================================

model Consultation {
  id              String             @id @default(uuid())
  consultant_id   String
  client_id       String?
  title           String             @db.VarChar(255)
  description     String?            @db.Text
  category        String             @db.VarChar(100)
  price_uzs       BigInt
  duration_min    Int                @default(60)
  status          ConsultationStatus @default(AVAILABLE)
  scheduled_at    DateTime?          @db.Timestamptz
  completed_at    DateTime?          @db.Timestamptz
  rating          Decimal?           @db.Decimal(2, 1)
  review          String?            @db.Text
  created_at      DateTime           @default(now()) @db.Timestamptz

  consultant Account  @relation("consultant_sessions", fields: [consultant_id], references: [id])
  client     Account? @relation("client_sessions", fields: [client_id], references: [id])

  @@map("consultations")
}

enum ConsultationStatus {
  AVAILABLE
  BOOKED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================================
// PRICE TESTING (Feature 29 — A/B Price Testing)
// ============================================================

model PriceTest {
  id             String          @id @default(uuid())
  account_id     String
  product_id     BigInt
  original_price BigInt
  test_price     BigInt
  status         PriceTestStatus @default(PLANNED)
  start_date     DateTime?       @db.Timestamptz
  end_date       DateTime?       @db.Timestamptz
  original_sales Int             @default(0)
  test_sales     Int             @default(0)
  original_revenue BigInt        @default(0)
  test_revenue     BigInt        @default(0)
  conclusion     String?         @db.Text
  created_at     DateTime        @default(now()) @db.Timestamptz

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@map("price_tests")
}

enum PriceTestStatus {
  PLANNED
  RUNNING
  COMPLETED
  CANCELLED
}

// ============================================================
// PRODUCT CHECKLIST (Feature 28 — Product Launch Checklist)
// ============================================================

model ProductChecklist {
  id         String   @id @default(uuid())
  account_id String
  product_id BigInt?
  title      String   @db.VarChar(255)
  items      Json     @default("[]")
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@map("product_checklists")
}

// ============================================================
// ADS ROI TRACKING (Feature 31 — Uzum Ads ROI Tracker)
// ============================================================

model AdCampaign {
  id              String           @id @default(uuid())
  account_id      String
  product_id      BigInt?
  name            String           @db.VarChar(255)
  platform        String           @db.VarChar(50) @default("uzum")
  budget_uzs      BigInt           @default(0)
  spent_uzs       BigInt           @default(0)
  impressions     Int              @default(0)
  clicks          Int              @default(0)
  conversions     Int              @default(0)
  revenue_uzs     BigInt           @default(0)
  status          AdCampaignStatus @default(ACTIVE)
  start_date      DateTime?        @db.Timestamptz
  end_date        DateTime?        @db.Timestamptz
  created_at      DateTime         @default(now()) @db.Timestamptz
  updated_at      DateTime         @updatedAt @db.Timestamptz

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@map("ad_campaigns")
}

enum AdCampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
}

// ============================================================
// TEAM COLLABORATION (Feature 33)
// ============================================================

model TeamInvite {
  id             String           @id @default(uuid())
  account_id     String
  email          String           @db.VarChar(255)
  role           UserRole         @default(USER)
  token          String           @unique @db.VarChar(64)
  status         InviteStatus     @default(PENDING)
  invited_by     String
  expires_at     DateTime         @db.Timestamptz
  created_at     DateTime         @default(now()) @db.Timestamptz

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@map("team_invites")
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

// ============================================================
// CUSTOM REPORTS (Feature 34 — Custom Report Builder)
// ============================================================

model CustomReport {
  id             String   @id @default(uuid())
  account_id     String
  title          String   @db.VarChar(255)
  description    String?  @db.Text
  report_type    String   @db.VarChar(50) // "product", "category", "shop", "market"
  filters        Json     @default("{}")
  columns        Json     @default("[]")
  schedule       String?  @db.VarChar(50) // "daily", "weekly", "monthly"
  last_run_at    DateTime? @db.Timestamptz
  created_at     DateTime @default(now()) @db.Timestamptz
  updated_at     DateTime @updatedAt @db.Timestamptz

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@map("custom_reports")
}

// ============================================================
// SHARED WATCHLIST (Feature 36 — Watchlist Sharing)
// ============================================================

model SharedWatchlist {
  id          String   @id @default(uuid())
  account_id  String
  name        String   @db.VarChar(255)
  description String?  @db.Text
  product_ids Json     @default("[]")
  is_public   Boolean  @default(false)
  share_token String?  @unique @db.VarChar(64)
  views       Int      @default(0)
  created_at  DateTime @default(now()) @db.Timestamptz
  updated_at  DateTime @updatedAt @db.Timestamptz

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([account_id])
  @@map("shared_watchlists")
}

// ============================================================
// COMMUNITY INTELLIGENCE (Feature 38)
// ============================================================

model CommunityInsight {
  id          String   @id @default(uuid())
  account_id  String
  title       String   @db.VarChar(255)
  content     String   @db.Text
  category    String   @db.VarChar(100)
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  created_at  DateTime @default(now()) @db.Timestamptz

  account Account         @relation(fields: [account_id], references: [id], onDelete: Cascade)
  votes   InsightVote[]

  @@index([account_id])
  @@map("community_insights")
}

model InsightVote {
  id         String   @id @default(uuid())
  insight_id String
  account_id String
  vote       Int      // +1 or -1
  created_at DateTime @default(now()) @db.Timestamptz

  insight CommunityInsight @relation(fields: [insight_id], references: [id], onDelete: Cascade)

  @@unique([insight_id, account_id])
  @@map("insight_votes")
}

// ============================================================
// USER ACTIVITY & SESSIONS (Admin v5)
// ============================================================

model UserActivity {
  id         String   @id @default(uuid())
  user_id    String
  account_id String
  action     String   @db.VarChar(50)
  details    Json?
  ip         String?  @db.VarChar(45)
  user_agent String?  @db.VarChar(500)
  created_at DateTime @default(now()) @db.Timestamptz

  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([account_id, created_at])
  @@map("user_activities")
}

model UserSession {
  id                 String    @id @default(uuid())
  user_id            String
  refresh_token_hash String?   @db.VarChar(128)
  expires_at         DateTime? @db.Timestamptz
  revoked_at         DateTime? @db.Timestamptz
  ip                 String?   @db.VarChar(45)
  user_agent         String?   @db.VarChar(500)
  device_type        String?   @db.VarChar(50)
  logged_in_at       DateTime  @default(now()) @db.Timestamptz

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, logged_in_at])
  @@index([refresh_token_hash])
  @@map("user_sessions")
}

// ============================================================
// NOTIFICATIONS (Admin v5)
// ============================================================

model Notification {
  id         String   @id @default(uuid())
  account_id String?
  message    String   @db.VarChar(500)
  type       String   @db.VarChar(20) @default("info")
  is_read    Boolean  @default(false)
  created_by String?
  created_at DateTime @default(now()) @db.Timestamptz

  account Account? @relation(fields: [account_id], references: [id])

  @@index([account_id, is_read])
  @@index([created_at])
  @@map("notifications")
}

// ============================================================
// FEEDBACK & CHAT (Admin v5)
// ============================================================

model FeedbackTicket {
  id         String           @id @default(uuid())
  account_id String
  user_id    String
  subject    String           @db.VarChar(200)
  type       FeedbackType     @default(OTHER)
  priority   FeedbackPriority @default(MEDIUM)
  status     FeedbackStatus   @default(OPEN)
  created_at DateTime         @default(now()) @db.Timestamptz
  updated_at DateTime         @updatedAt @db.Timestamptz

  account  Account           @relation(fields: [account_id], references: [id], onDelete: Cascade)
  user     User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  messages FeedbackMessage[]

  @@index([account_id, status])
  @@index([status, created_at])
  @@map("feedback_tickets")
}

model FeedbackMessage {
  id         String   @id @default(uuid())
  ticket_id  String
  sender_id  String
  content    String   @db.Text
  is_admin   Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamptz

  ticket FeedbackTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  sender User           @relation(fields: [sender_id], references: [id])

  @@index([ticket_id, created_at])
  @@map("feedback_messages")
}

enum FeedbackType {
  BUG
  FEATURE
  QUESTION
  OTHER
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
}

enum FeedbackStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

// ============================================================
// NOTIFICATION TEMPLATES (Admin v6)
// ============================================================

model NotificationTemplate {
  id         String   @id @default(uuid())
  name       String   @db.VarChar(100)
  message    String   @db.VarChar(500)
  type       String   @db.VarChar(20) @default("info")
  created_by String?
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @updatedAt @db.Timestamptz

  @@map("notification_templates")
}

// ============================================================
// AI USAGE LOG (Admin v6 — Token & Cost Tracking)
// ============================================================

model AiUsageLog {
  id            String   @id @default(uuid())
  account_id    String?
  user_id       String?
  method        String   @db.VarChar(50)
  model         String   @db.VarChar(50)
  input_tokens  Int      @default(0)
  output_tokens Int      @default(0)
  cost_usd      Decimal  @db.Decimal(10, 6) @default(0)
  product_id    String?  @db.VarChar(50)
  duration_ms   Int?
  error         String?  @db.Text
  created_at    DateTime @default(now()) @db.Timestamptz

  @@index([created_at])
  @@index([account_id, created_at])
  @@map("ai_usage_logs")
}

// ============================================================
// SYSTEM ERROR LOG (Admin v6 — Error Tracking)
// ============================================================

model SystemError {
  id         String   @id @default(uuid())
  endpoint   String   @db.VarChar(255)
  method     String   @db.VarChar(10)
  status     Int
  message    String   @db.Text
  stack      String?  @db.Text
  account_id String?
  user_id    String?
  ip         String?  @db.VarChar(45)
  user_agent String?  @db.VarChar(500)
  created_at DateTime @default(now()) @db.Timestamptz

  @@index([created_at])
  @@index([endpoint, created_at])
  @@index([account_id, created_at])
  @@map("system_errors")
}
