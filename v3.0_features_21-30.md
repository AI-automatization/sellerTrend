# UZUM TREND FINDER â€” v3.0
# FEATURES 21â€“30: REAL-TIME SIGNALS + SELLER WORKFLOW TOOLS
# Claude CLI uchun to'liq texnik tavsif

> v1.0 + v2.0 ustiga quriladi.

---

## FEATURE 21 â€” CANNIBALIZATION ALERT

### Nima?
Bir shop o'z 2 ta mahsuloti orasida raqobat qilmoqda â€” biri ikkinchisini "yemoqda".

### Aniqlash algoritmi
```typescript
async function detectCannibalization(shopId: number): Promise<CannibalizationResult[]> {
  // 1. Bu shopning barcha mahsulotlarini ol
  const products = await prisma.product.findMany({
    where: { shop_id: shopId, is_active: true },
    include: { snapshots: { orderBy: { snapshot_at: 'desc' }, take: 14 } }
  });

  const cannibalizationPairs: CannibalizationResult[] = [];

  // 2. Juftlik bo'yicha taqqosla
  for (let i = 0; i < products.length; i++) {
    for (let j = i + 1; j < products.length; j++) {
      const a = products[i];
      const b = products[j];

      // Bir xil kategoriya + o'xshash narx range (Â±20%)
      const sameCategory = a.category_id === b.category_id;
      const similarPrice = Math.abs(a.min_sell_price - b.min_sell_price) /
                           Math.max(a.min_sell_price, b.min_sell_price) < 0.20;

      if (!sameCategory || !similarPrice) continue;

      // Negative correlation: biri o'ssa, biri kamayadi
      const correlation = pearsonCorrelation(
        a.snapshots.map(s => s.orders_quantity),
        b.snapshots.map(s => s.orders_quantity)
      );

      if (correlation < -0.6) { // kuchli teskari korrelyatsiya
        cannibalizationPairs.push({
          product_a: a,
          product_b: b,
          correlation,
          recommendation: `"${a.title}" yoki "${b.title}" ni olib tashlashni ko'ring`
        });
      }
    }
  }

  return cannibalizationPairs;
}

function pearsonCorrelation(x: number[], y: number[]): number {
  const n = Math.min(x.length, y.length);
  const meanX = x.slice(0, n).reduce((a, b) => a + b, 0) / n;
  const meanY = y.slice(0, n).reduce((a, b) => a + b, 0) / n;
  const num = x.slice(0, n).reduce((s, xi, i) => s + (xi - meanX) * (y[i] - meanY), 0);
  const den = Math.sqrt(
    x.slice(0, n).reduce((s, xi) => s + (xi - meanX) ** 2, 0) *
    y.slice(0, n).reduce((s, yi) => s + (yi - meanY) ** 2, 0)
  );
  return den === 0 ? 0 : num / den;
}
```

### DB
```sql
CREATE TABLE cannibalization_alerts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID REFERENCES accounts(id),
  shop_id BIGINT REFERENCES shops(id),
  product_a_id BIGINT REFERENCES products(id),
  product_b_id BIGINT REFERENCES products(id),
  correlation DECIMAL(5,4),
  status VARCHAR(20) DEFAULT 'OPEN',    -- OPEN | DISMISSED | RESOLVED
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## FEATURE 22 â€” DEAD STOCK PREDICTOR

### Nima?
`ordersQuantity` o'smayapti + narx kamaymoqda + past feedback â†’ stokda qolib ketish xavfi.

### Dead Stock Score
```typescript
function deadStockScore(product: {
  orders_growth_14d: number;  -- % (manfiy bo'lishi mumkin)
  price_change_14d: number;   -- % (narx tushayotganmi?)
  feedback_quantity: number;
  stock_age_days: number;     -- Uzum da qancha vaqt bor
  current_score: number;
}): DeadStockAnalysis {

  let risk = 0;

  // Sotuv o'smayapti yoki kamaymoqda
  if (product.orders_growth_14d < 0)   risk += 35;
  else if (product.orders_growth_14d < 5) risk += 15;

  // Narx tushirilmoqda (clearing belgisi)
  if (product.price_change_14d < -10)  risk += 25;
  else if (product.price_change_14d < -5) risk += 10;

  // Kam review (bozor qabul qilmagan)
  if (product.feedback_quantity < 10)  risk += 20;

  // Juda eski mahsulot
  if (product.stock_age_days > 180)    risk += 20;

  return {
    risk_score: Math.min(risk, 100),
    risk_level: risk > 70 ? 'HIGH' : risk > 40 ? 'MEDIUM' : 'LOW',
    recommendations: generateDeadStockRecommendations(product, risk)
  };
}

function generateDeadStockRecommendations(p: any, risk: number): string[] {
  const recs = [];
  if (risk > 70) recs.push("Narxni 30-50% pasaytiring â€” tezkor sotish");
  if (p.feedback_quantity < 10) recs.push("Review yig'ish kampaniyasi o'tkazing");
  if (p.price_change_14d < -10) recs.push("Narx tushirish samarasiz â€” boshqa strategiya kerak");
  return recs;
}
```

### Cron job (weekly)
```typescript
// Har hafta barcha tracked_products uchun dead stock scan
@Cron('0 9 * * 1') // Dushanba 09:00
async deadStockWeeklyScan() {
  const products = await getTrackedProducts();
  for (const p of products) {
    const analysis = deadStockScore(buildMetrics(p));
    if (analysis.risk_level === 'HIGH') {
      await createAlert(p.account_id, 'DEAD_STOCK', analysis);
    }
  }
}
```

---

## FEATURE 23 â€” CATEGORY SATURATION INDEX

### Nima?
Kategoriyaga kirish oldidan: bu bozor to'yinganmi yoki imkoniyat bormi?

### Saturation formulasi
```typescript
interface CategorySaturation {
  category_id: number;
  total_sellers: number;
  top10_market_share_pct: number;  // top 10 shopning bozor ulushi
  avg_entry_score: number;         // yangi mahsulotning o'rtacha score si
  median_reviews: number;          // o'rtacha review soni
  price_range: [number, number];   // eng past va eng yuqori narx
  saturation_score: number;        // 0-100 (100 = to'yingan)
}

function calculateSaturation(category: CategoryData): number {
  // Herfindahl-Hirschman Index (bozor kontsentratsiyasi)
  const hhi = category.shops
    .map(s => (s.orders_share * 100) ** 2)
    .reduce((a, b) => a + b, 0);

  const concentration = hhi / 10000; // 0-1

  // Narx siqilishi: min va max orasidagi farq kichik = to'yingan
  const price_compression = 1 - (category.price_std / category.avg_price);

  // O'sish dinamikasi
  const growth_factor = 1 - (category.monthly_growth_pct / 50);

  return Math.round((concentration * 0.4 + price_compression * 0.3 + growth_factor * 0.3) * 100);
}
```

### UI
- Gauge chart: 0-100 (yashil=ochiq, sariq=o'rta, qizil=to'yingan)
- "Kirish tavsiyasi": Jadval â€” Narx, Minimum review kerak, Kutilgan ROI
- Top shoplar bozor ulushi (Pie chart)

---

## FEATURE 24 â€” FLASH SALE DETECTOR

### Nima?
Narx keskin tushdi (24 soat ichida -20%+) â†’ flash sale yoki clearing â†’ raqiblar ham shunday qilishi mumkin.

### Aniqlash
```typescript
// Snapshot har 6 soatda olinadi
// Oxirgi 4 snapshot (24 soat) ni taqqosla
async function detectFlashSale(productId: number): Promise<FlashSaleSignal | null> {
  const snapshots = await getRecentSnapshots(productId, 4);

  if (snapshots.length < 2) return null;

  const oldest = snapshots[snapshots.length - 1];
  const newest = snapshots[0];
  const priceChange = (newest.sell_price - oldest.sell_price) / oldest.sell_price;

  if (priceChange < -0.20) { // 20%+ tushish
    return {
      product_id: productId,
      price_before: oldest.sell_price,
      price_after: newest.sell_price,
      change_pct: priceChange * 100,
      detected_at: new Date(),
      type: priceChange < -0.40 ? 'FLASH_SALE' : 'DISCOUNT'
    };
  }

  return null;
}
```

### Real-time monitoring
```typescript
// Har snapshot olingandan keyin tekshiriladi
// Flash sale topilsa â†’ WebSocket orqali dashboard ga push
// Tracked product bo'lsa â†’ Telegram alert
```

### DB
```sql
CREATE TABLE flash_sale_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id BIGINT REFERENCES products(id),
  price_before BIGINT,
  price_after BIGINT,
  change_pct DECIMAL(6,2),
  event_type VARCHAR(20),      -- FLASH_SALE | DISCOUNT | CLEARANCE
  started_at TIMESTAMPTZ,
  ended_at TIMESTAMPTZ,        -- narx qaytganda
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## FEATURE 25 â€” NEW PRODUCT EARLY SIGNAL

### Nima?
`feedbackQuantity` 0-50 orasida lekin `ordersQuantity` tez o'smoqda â†’ yangi mahsulot "uchmoqda".

### Early Signal Score
```typescript
function earlySignalScore(product: {
  feedback_quantity: number;
  orders_quantity: number;
  orders_growth_7d: number;   -- oxirgi 7 kunlik delta
  days_since_listed: number;  -- Uzum da qancha kun bor
}): EarlySignal | null {

  // Faqat yangi mahsulotlar (90 kun dan kam)
  if (product.days_since_listed > 90) return null;
  if (product.feedback_quantity > 50) return null;

  const velocity = product.orders_growth_7d / (product.days_since_listed + 1);
  const early_score = velocity * Math.log(1 + product.orders_quantity);

  if (early_score < 10) return null; // juda past

  return {
    early_score,
    signal_strength: early_score > 50 ? 'STRONG' : 'MODERATE',
    estimated_weekly_growth_pct: (product.orders_growth_7d / product.orders_quantity * 100).toFixed(1),
    recommendation: "Bu mahsulotni kuzatishga qo'shing â€” erta signal aniqlandi"
  };
}
```

### Scan: har 12 soatda
```typescript
// Barcha yangi mahsulotlar (90 kun ichida) skan qilinadi
// Early signal topilsa â†’ "Yangi tendensiya" bo'limida ko'rsatiladi
```

---

## FEATURE 26 â€” STOCK CLIFF ALERT

### Nima?
Stok keskin kamaydi â†’ raqib stoksiz qolganda sizning mahsulotingiz yuqori chiqadi.

### Aniqlash
```typescript
// Uzum product detail dan stock_quantity olinadi (agar mavjud bo'lsa)
// Alternative: narx ko'tarilishi va delivery date uzayishi = stok tugamoqda belgisi

async function detectStockCliff(productId: number): Promise<StockAlert | null> {
  const snapshots = await getRecentSnapshots(productId, 7);

  // Delivery date uzaydi: "Bugun" â†’ "3-5 kun" â†’ stok tugamoqda
  const deliverySlippage = detectDeliverySlippage(snapshots);

  // Narx ko'tarildi + delivery uzaydi = kuchli signal
  const priceIncrease = snapshots[0].sell_price > snapshots[6].sell_price * 1.05;

  if (deliverySlippage && priceIncrease) {
    return {
      product_id: productId,
      signal: 'STOCK_LOW',
      opportunity: 'Raqib stoksiz qolmoqda â€” sizning mahsulotingiz yaxshiroq pozitsiyaga chiqishi mumkin',
      urgency: 'HIGH'
    };
  }

  return null;
}
```

### Tactical Window Alert (Telegram)
```
ðŸš¨ Stock Cliff Signal!

Mahsulot: Ð‘ÑƒÐ¼Ð°Ð³Ð° Svetocopy A4
Raqib shop: Paper Store UZ
Signal: Yetkazish 5-7 kunga uzaydi + narx 8% ko'tarildi

ðŸ’¡ Imkoniyat: Shu mahsulotni FBO ga ko'proq stok qiling.
Raqib stoksiz qolganda siz top pozitsiyaga chiqasiz.
```

---

## FEATURE 27 â€” RANKING POSITION TRACKER

### Nima?
Mahsulot kategoriya sahifasida nechi o'rinda â€” bu o'zgarishni kuzatish.

### Qanday ishlaydi?
```typescript
// makeSearch da mahsulotlar tartib bo'yicha keladi
// items[0] = 1-o'rin, items[1] = 2-o'rin, va hokazo
// Pagination: page=0 â†’ 1-48, page=1 â†’ 49-96

async function trackRankingPosition(productId: number, categoryId: number): Promise<number | null> {
  let position = null;

  for (let page = 0; page < 10; page++) { // max 480 ta mahsulot
    const items = await uzumClient.fetchCategoryListing(categoryId, page);

    const found = items.findIndex(item =>
      item.catalogCard.productId === productId
    );

    if (found !== -1) {
      position = page * 48 + found + 1; // 1-based
      break;
    }

    if (items.length < 48) break; // Oxirgi sahifa
  }

  return position;
}
```

### DB
```sql
CREATE TABLE ranking_snapshots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id BIGINT REFERENCES products(id),
  category_id BIGINT NOT NULL,
  position INT,                  -- null = topilmadi
  page INT,
  snapshot_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Ranking o'zgarish alert
```
Bir kunda 10+ pozitsiya ko'tarildi yoki tushdi â†’ alert
```

### UI
- Grafik: pozitsiya dinamikasi (pastroq = yaxshiroq)
- "Sizning mahsulotingiz bugun #12 da" badge
- "Hafta ichida 8 pozitsiya ko'tarildi â†‘" insight

---

## FEATURE 28 â€” PRODUCT LAUNCH CHECKLIST

### Nima?
Yangi mahsulot qo'yishdan oldin to'liq tayyorgarlik ro'yxati.

### Checklist tuzilmasi
```typescript
interface LaunchChecklist {
  // 1. Bozor tahlil
  market: {
    niche_score: number;           // Feature 04
    saturation_score: number;      // Feature 23
    competitor_count: number;
    avg_competitor_price: number;
    recommended_price: number;
    entry_difficulty: 'EASY'|'MEDIUM'|'HARD';
  };

  // 2. SEO tayyorgarlik
  seo: {
    title_optimized: boolean;
    description_length: number;    // 500+ kerak
    keywords_included: string[];
    photos_count: number;          // 5+ kerak
  };

  // 3. Raqobat
  competition: {
    top_competitor: ShopProfile;
    price_gap_pct: number;         // sizning narxingiz raqibdan farqi
    trust_score_gap: number;
    estimated_days_to_top10: number;
  };

  // 4. Moliyaviy
  financial: {
    breakeven_units: number;       // Feature 09
    estimated_monthly_profit: number;
    roi_pct: number;
  };

  // 5. Tavsiyalar
  recommendations: string[];
  ready_to_launch: boolean;
  missing_items: string[];
}
```

### API
```
POST /api/launch-checklist
Body: { category_id, sell_price, purchase_price, product_url? }
â†’ LaunchChecklist (1-2 soniya, chunki bir nechta hisoblash)
```

### UI
- Progress ring: tayyor bo'lish darajasi %
- Har bo'lim uchun âœ…/âš ï¸/âŒ status
- "Nimalar yetishmayapti" ro'yxati

---

## FEATURE 29 â€” A/B PRICE TESTING

### Nima?
2 ta narx variant belgilaydi â†’ tizim hafta davomida kuzatadi, qaysi biri yaxshiroq natija beradigani aniqlanadi.

### Qanday ishlaydi?
```typescript
// Sotuvchi Uzum da narxni o'zgartiradi â€” biz kuzatamiz
// Tizim avtomatik ravishda "test davri" aniqlaydi

interface AbPriceTest {
  id: string;
  product_id: number;
  variant_a: {
    price: number;
    period: [Date, Date];
    avg_daily_orders: number;
    total_revenue: number;
  };
  variant_b: {
    price: number;
    period: [Date, Date];
    avg_daily_orders: number;
    total_revenue: number;
  };
  winner: 'A' | 'B' | 'INCONCLUSIVE';
  confidence_pct: number;
  recommendation: string;
}
```

### Statistik muhimlik (t-test)
```typescript
function isStatisticallySignificant(a: number[], b: number[]): {
  significant: boolean;
  confidence: number;
} {
  // Welch's t-test
  const meanA = avg(a), meanB = avg(b);
  const varA = variance(a), varB = variance(b);
  const tStat = (meanA - meanB) /
    Math.sqrt(varA / a.length + varB / b.length);

  const confidence = 1 - pValue(tStat);
  return { significant: confidence > 0.90, confidence };
}
```

---

## FEATURE 30 â€” REPLENISHMENT PLANNER

### Nima?
Stok + o'rtacha kunlik sotuv â†’ "Sizda N kun uchun stok qoldi" + buyurtma vaqti.

### Hisoblash
```typescript
function replenishmentPlan(data: {
  current_stock: number;         // Uzum omboridagi qoldiq
  avg_daily_sales: number;       // oxirgi 30 kunlik o'rtacha
  lead_time_days: number;        // yetkazib berish vaqti (default: 14 kun)
  safety_stock_days: number;     // xavfsizlik zaxirasi (default: 7 kun)
  min_order_quantity: number;    // minimum buyurtma
}): ReplenishmentResult {

  const days_remaining = data.current_stock / data.avg_daily_sales;
  const reorder_point = (data.lead_time_days + data.safety_stock_days) * data.avg_daily_sales;
  const reorder_now = data.current_stock <= reorder_point;

  const optimal_order_qty = Math.max(
    data.min_order_quantity,
    Math.ceil(data.avg_daily_sales * (data.lead_time_days + 30)) // 30 kun uchun
  );

  return {
    days_remaining: Math.floor(days_remaining),
    reorder_date: addDays(new Date(), days_remaining - data.lead_time_days),
    reorder_now,
    urgency: reorder_now ? (days_remaining < data.lead_time_days ? 'CRITICAL' : 'HIGH') : 'LOW',
    optimal_order_qty,
    estimated_cost: optimal_order_qty * data.purchase_price
  };
}
```

### DB
```sql
ALTER TABLE tracked_products ADD COLUMN purchase_price BIGINT;
ALTER TABLE tracked_products ADD COLUMN lead_time_days INT DEFAULT 14;
ALTER TABLE tracked_products ADD COLUMN min_order_qty INT DEFAULT 50;
```

### Telegram alert
```
ðŸ“¦ Stok ogohlantirishÐ¸!

Mahsulot: Ð‘ÑƒÐ¼Ð°Ð³Ð° Svetocopy A4
Qolgan stok: ~12 kun uchun yetadi
Buyurtma vaqti: 2025-03-05 (bugundan 5 kun)
Tavsiya etilgan miqdor: 500 dona

âš ï¸ Hozir buyurtma bermang â†’ stoksiz qolish xavfi!
```

---

## v3.0 DELIVERY CHECKLIST

```
âœ… Feature 21: Cannibalization Alert (Pearson correlation)
âœ… Feature 22: Dead Stock Predictor (weekly cron)
âœ… Feature 23: Category Saturation Index (HHI formula)
âœ… Feature 24: Flash Sale Detector (6-soatlik monitoring)
âœ… Feature 25: New Product Early Signal (velocity score)
âœ… Feature 26: Stock Cliff Alert (delivery slippage detection)
âœ… Feature 27: Ranking Position Tracker (pagination crawler)
âœ… Feature 28: Product Launch Checklist (composite API)
âœ… Feature 29: A/B Price Testing (t-test statistical significance)
âœ… Feature 30: Replenishment Planner (Telegram + DB)
```

---
*v3.0 | Features 21-30 | Faza 3 uchun*