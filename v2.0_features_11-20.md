# UZUM TREND FINDER ‚Äî v2.0
# FEATURES 11‚Äì20: AI-POWERED + TECH IMPROVEMENTS + DATA INTELLIGENCE (1-qism)
# Claude CLI uchun to'liq texnik tavsif

> v1.0 ustiga quriladi. v1.0 to'liq ishlamasdan bu versiyani boshlamang.

---

## FEATURE 11 ‚Äî TREND PREDICTION (ML)

### Nima?
7 kunlik snapshot tarixidan keyingi 7 kunning `ordersQuantity` ni bashorat qilish.

### Algoritm (Linear Regression ‚Äî boshida yetarli)
```typescript
// packages/utils/src/prediction.ts
function linearRegression(points: {x: number, y: number}[]): {slope: number, intercept: number} {
  const n = points.length;
  const sumX = points.reduce((s, p) => s + p.x, 0);
  const sumY = points.reduce((s, p) => s + p.y, 0);
  const sumXY = points.reduce((s, p) => s + p.x * p.y, 0);
  const sumX2 = points.reduce((s, p) => s + p.x * p.x, 0);

  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;
  return { slope, intercept };
}

function predictNextWeek(snapshots: ProductSnapshot[]): PredictionResult {
  // Oxirgi 14 snapshotni ol (2 hafta)
  const recent = snapshots.slice(-14);
  const points = recent.map((s, i) => ({
    x: i,
    y: Number(s.orders_quantity)
  }));

  const { slope, intercept } = linearRegression(points);

  // Keyingi 7 kun uchun bashorat
  const predictions = Array.from({length: 7}, (_, i) => ({
    day: i + 1,
    predicted_orders: Math.round(intercept + slope * (points.length + i)),
    confidence: calculateConfidence(points, slope, intercept)
  }));

  const trend: 'UP' | 'DOWN' | 'STABLE' =
    slope > 50 ? 'UP' : slope < -50 ? 'DOWN' : 'STABLE';

  return { predictions, trend, slope, confidence_avg: avg(predictions.map(p => p.confidence)) };
}
```

### DB
```sql
CREATE TABLE product_predictions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id BIGINT REFERENCES products(id),
  predicted_for_date DATE NOT NULL,
  predicted_orders BIGINT,
  trend VARCHAR(10),          -- UP | DOWN | STABLE
  confidence DECIMAL(4,3),   -- 0.000 - 1.000
  slope DECIMAL(10,4),
  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(product_id, predicted_for_date)
);
```

### API
```
GET /api/products/:id/prediction
‚Üí {
    trend: "UP",
    next_7_days: [{day, predicted_orders, confidence}],
    insight: "Bu mahsulot hafta ichida ~23% o'sishi kutilmoqda",
    confidence_level: "MEDIUM"  -- LOW < 0.5, MEDIUM < 0.8, HIGH >= 0.8
  }
```

### UI
- Recharts LineChart: tarixiy (qattiq chiziq) + bashorat (nuqtali chiziq)
- Trend badge: üìà O'smoqda | üìâ Pasaymoqda | ‚û°Ô∏è Barqaror
- Confidence indicator: yulduzcha (1-5)

---

## FEATURE 12 ‚Äî AUTO PRODUCT DESCRIPTION GENERATOR

### Nima?
Sotuvchi mahsulot nomi beradi ‚Üí Claude API avtomatik Uzum uchun optimallashtirilgan tavsif yozadi (Ruscha + O'zbekcha).

### Claude prompt
```typescript
const DESCRIPTION_PROMPT = `
Siz Uzum marketplace uchun mahsulot tavsifi yozuvchi mutaxasssissiz.

Mahsulot: {title}
Kategoriya: {category}
Narx: {price} —Å—É–º
Asosiy xususiyatlar: {characteristics}

Quyidagi JSON formatida qaytaring:
{
  "title_ru": "Qisqa, jozibali sarlavha (ruscha, 60 belgi max)",
  "title_uz": "Qisqa, jozibali sarlavha (o'zbekcha, 60 belgi max)",
  "description_ru": "To'liq tavsif (ruscha, 500-800 belgi, SEO kalit so'zlar bilan)",
  "description_uz": "To'liq tavsif (o'zbekcha, 500-800 belgi)",
  "key_features_ru": ["Xususiyat 1", "Xususiyat 2", "Xususiyat 3"],
  "key_features_uz": ["Xususiyat 1", "Xususiyat 2", "Xususiyat 3"],
  "seo_keywords": ["kalit so'z 1", "kalit so'z 2"]
}

Faqat JSON qaytaring, boshqa hech narsa yozmang.
`;
```

### Caching strategiyasi
```typescript
// product_ai_attributes da cache ‚Äî bir marta generate, saqla
async generateDescription(productId: number): Promise<Description> {
  // Cache tekshir
  const cached = await prisma.productAiAttributes.findUnique({
    where: { product_id: productId }
  });
  if (cached?.description_ru) return cached;

  // Claude API
  const response = await anthropic.messages.create({
    model: 'claude-sonnet-4-6',
    max_tokens: 1000,
    messages: [{ role: 'user', content: buildPrompt(product) }]
  });

  // Parse va saqlash
  const description = JSON.parse(response.content[0].text);
  await prisma.productAiAttributes.upsert({
    where: { product_id: productId },
    update: description,
    create: { product_id: productId, ...description }
  });

  return description;
}
```

### Token hisob-kitob
```
O'rtacha so'rov: ~300 input tokens + ~400 output tokens = 700 tokens
Claude Sonnet narxi: ~$0.003 per 1K tokens
Bir tavsif: ~$0.002
1000 mahsulot: ~$2 ‚Üí juda arzon
```

### UI
- Forma: Mahsulot nomi, kategoriya tanlash
- "Generate" tugmasi ‚Üí loading ‚Üí natija
- Nusxalash tugmasi (clipboard)
- Tahrirlash imkoniyati

---

## FEATURE 13 ‚Äî REVIEW SENTIMENT ANALYSIS

### Nima?
Raqib mahsulotining reviewlarini tahlil qilish ‚Üí qaysi muammolar bor ‚Üí o'z mahsulotingizni yaxshilash.

### Uzum review API
```typescript
// productReviews query
const REVIEWS_QUERY = `
query productReviews($productId: Int!, $limit: Int!, $offset: Int!) {
  productReviews(productId: $productId, limit: $limit, offset: $offset) {
    reviews {
      id
      rating
      text
      pros
      cons
      createdAt
    }
    total
  }
}
`;
```

### Sentiment analiz (Claude)
```typescript
const SENTIMENT_PROMPT = `
Quyidagi mahsulot reviewlarini tahlil qiling:

{reviews_text}

JSON formatida qaytaring:
{
  "overall_sentiment": "POSITIVE|NEGATIVE|MIXED",
  "main_complaints": ["Muammo 1", "Muammo 2"],
  "main_praises": ["Yaxshi jihati 1", "Yaxshi jihati 2"],
  "improvement_suggestions": ["Tavsiya 1", "Tavsiya 2"],
  "keyword_frequency": {"sifat": 12, "narx": 8, "yetkazish": 5}
}
`;

// Optimizatsiya: 50 review batch larda yuborish
// Cache: snapshot_id + product_id bo'yicha
```

### DB
```sql
CREATE TABLE product_reviews_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id BIGINT REFERENCES products(id),
  review_id BIGINT UNIQUE NOT NULL,
  rating INT,
  text TEXT,
  pros TEXT,
  cons TEXT,
  sentiment VARCHAR(20),         -- AI tomonidan belgilanadi
  fetched_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE sentiment_analysis (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id BIGINT REFERENCES products(id),
  overall_sentiment VARCHAR(20),
  main_complaints TEXT[],
  main_praises TEXT[],
  improvement_suggestions TEXT[],
  analyzed_reviews_count INT,
  analyzed_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API
```
POST /api/products/:id/analyze-reviews
‚Üí {jobId}  (async, chunki ko'p review bo'lishi mumkin)

GET /api/products/:id/sentiment
‚Üí {overall, complaints, praises, suggestions, word_cloud}
```

---

## FEATURE 14 ‚Äî WHITE-LABEL

### Nima?
Yirik agentliklar uchun o'z brendida sotish. Bizning backend, ularning frontend brendi.

### Arxitektura
```sql
ALTER TABLE accounts ADD COLUMN plan VARCHAR(50) DEFAULT 'STANDARD';
-- STANDARD | WHITE_LABEL | ENTERPRISE

CREATE TABLE white_label_configs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID REFERENCES accounts(id) UNIQUE,
  brand_name VARCHAR(100),
  logo_url TEXT,
  primary_color VARCHAR(7),     -- #HEX
  custom_domain VARCHAR(255),   -- trend.mening-agentligim.uz
  custom_email_from VARCHAR(255),
  telegram_bot_token TEXT,      -- o'z bot uchun
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Custom domain
```nginx
# nginx.conf
server {
  server_name *.uzum-trend.uz trend.*.uz;
  # X-Account-Id header dan tenant aniqlanadi
}
```

### UI theming
```typescript
// CSS variables orqali dinamik tema
const applyTheme = (config: WhiteLabelConfig) => {
  document.documentElement.style.setProperty('--primary', config.primary_color);
  document.documentElement.style.setProperty('--logo-url', `url(${config.logo_url})`);
};
```

### Narxlash
```
White-label plan: 2,000,000 —Å—É–º/oy
Nima kiradi: custom domain, custom logo, o'z Telegram bot, 5 ta sub-account
```

---

## FEATURE 15 ‚Äî KONSULTATSIYA MARKETPLACE

### Nima?
Platformada e-commerce mutaxassislar bilan bog'lanish. Biz orqali ‚Üí bizga komissiya.

### DB
```sql
CREATE TABLE consultants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  display_name VARCHAR(255),
  bio TEXT,
  specializations TEXT[],      -- ["Oziq-ovqat", "Elektronika", "Kiyim"]
  hourly_rate BIGINT,          -- —Å—É–º/soat
  rating DECIMAL(3,2),
  total_sessions INT DEFAULT 0,
  is_verified BOOLEAN DEFAULT FALSE,
  telegram_username VARCHAR(100),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE consultation_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  consultant_id UUID REFERENCES consultants(id),
  client_account_id UUID REFERENCES accounts(id),
  status VARCHAR(50),            -- PENDING|CONFIRMED|COMPLETED|CANCELLED
  duration_minutes INT,
  total_price BIGINT,
  platform_commission BIGINT,   -- 20%
  consultant_payout BIGINT,     -- 80%
  session_date TIMESTAMPTZ,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Komissiya logikasi
```typescript
const PLATFORM_COMMISSION = 0.20; // 20%

async function bookSession(input: BookingInput) {
  const total = consultant.hourly_rate * (input.duration_minutes / 60);
  const commission = Math.floor(total * PLATFORM_COMMISSION);

  await prisma.consultationSession.create({
    data: {
      ...input,
      total_price: total,
      platform_commission: commission,
      consultant_payout: total - commission
    }
  });
}
```

---

## FEATURE 16 ‚Äî PWA (PROGRESSIVE WEB APP)

### Nima?
Alohida app yaratmasdan mobil qurilmalarda "o'rnatish" imkoniyati.

### manifest.json
```json
{
  "name": "Uzum Trend Finder",
  "short_name": "UTF",
  "description": "Uzum marketplace trend analitikasi",
  "start_url": "/dashboard",
  "display": "standalone",
  "background_color": "#0f172a",
  "theme_color": "#6366f1",
  "icons": [
    { "src": "/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

### Service Worker (offline support)
```javascript
// sw.js ‚Äî dashboard va leaderboard ni cache qilish
const CACHE_NAME = 'utf-v1';
const STATIC_ASSETS = ['/dashboard', '/leaderboard', '/offline.html'];

self.addEventListener('install', (e) => {
  e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(STATIC_ASSETS)));
});

self.addEventListener('fetch', (e) => {
  e.respondWith(
    caches.match(e.request).then(cached => cached || fetch(e.request))
    .catch(() => caches.match('/offline.html'))
  );
});
```

### Push Notifications
```typescript
// Alert kelganda push notification
async sendPushNotification(userId: string, alert: Alert) {
  const subscription = await getUserPushSubscription(userId);
  await webpush.sendNotification(subscription, JSON.stringify({
    title: 'üî• Alert: ' + alert.product_title,
    body: alert.message,
    icon: '/icon-192.png',
    url: `/products/${alert.product_id}`
  }));
}
```

---

## FEATURE 17 ‚Äî WEBSOCKET REAL-TIME UPDATES

### Nima?
Dashboard yangilash uchun sahifani qayta yuklamaslik. Score o'zgarishi, yangi alert ‚Äî darhol ko'rinadi.

### NestJS WebSocket Gateway
```typescript
@WebSocketGateway({ cors: true })
export class RealtimeGateway {

  @SubscribeMessage('subscribe:product')
  handleSubscribe(client: Socket, productId: number) {
    client.join(`product:${productId}`);
    return { event: 'subscribed', data: { productId } };
  }

  // Snapshot olinganda chaqiriladi
  async broadcastScoreUpdate(productId: number, newScore: number) {
    this.server.to(`product:${productId}`).emit('score:updated', {
      productId,
      score: newScore,
      timestamp: new Date().toISOString()
    });
  }

  // Yangi alert
  async broadcastAlert(accountId: string, alert: Alert) {
    this.server.to(`account:${accountId}`).emit('alert:new', alert);
  }
}
```

### React client
```typescript
// hooks/useRealtime.ts
export function useProductRealtime(productId: number) {
  const [score, setScore] = useState<number>();

  useEffect(() => {
    const socket = io(WS_URL, { auth: { token: getJwt() } });
    socket.emit('subscribe:product', productId);
    socket.on('score:updated', (data) => {
      if (data.productId === productId) setScore(data.score);
    });
    return () => socket.disconnect();
  }, [productId]);

  return { score };
}
```

---

## FEATURE 18 ‚Äî MULTI-LANGUAGE (i18n)

### Tillar: O'zbekcha (UZ) | Ruscha (RU) | Inglizcha (EN)

### React i18n setup (react-i18next)
```typescript
// i18n/uz.json
{
  "dashboard": {
    "title": "Bosh sahifa",
    "score": "Trend ko'rsatkichi",
    "weekly_bought": "Haftalik sotuvlar",
    "leaderboard": "Reytin–≥ jadvali"
  },
  "alerts": {
    "price_drop": "Narx tushdi: {{product}} ‚Äî {{percent}}%",
    "stock_low": "Qoldiq kam: {{product}}"
  }
}

// i18n/ru.json
{
  "dashboard": {
    "title": "–ì–ª–∞–≤–Ω–∞—è",
    "score": "–¢—Ä–µ–Ω–¥-–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å",
    "weekly_bought": "–ö—É–ø–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é",
    "leaderboard": "–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤"
  }
}
```

### Backend ham i18n
```typescript
// Telegram xabarlar uchun
function getAlertMessage(alert: Alert, lang: 'uz'|'ru'|'en'): string {
  const messages = {
    uz: `üî• ${alert.product_title} narxi ${alert.percent}% tushdi!`,
    ru: `üî• –¶–µ–Ω–∞ ${alert.product_title} —É–ø–∞–ª–∞ –Ω–∞ ${alert.percent}%!`,
    en: `üî• ${alert.product_title} price dropped by ${alert.percent}%!`
  };
  return messages[lang];
}
```

### Language detection
```typescript
// User brauzer tilidan aniqlanadi, sozlamada o'zgartiriladi
ALTER TABLE users ADD COLUMN preferred_lang VARCHAR(5) DEFAULT 'ru';
```

---

## FEATURE 19 ‚Äî DEMAND-SUPPLY GAP DETECTOR

### Nima?
`ordersQuantity` o'smoqda lekin raqiblar kam + `feedbackQuantity` sekin o'smoqda ‚Üí kirish imkoniyati.

### Gap Score formulasi
```typescript
function demandSupplyGap(data: {
  orders_growth_pct: number;       // oxirgi 30 kun o'sish %
  competitor_count: number;
  avg_competitor_score: number;
  new_products_this_month: number; // shu kategoriyaga yangi kirganlar
}): GapAnalysis {

  const demand_signal = data.orders_growth_pct / 100;
  const supply_signal = Math.log(1 + data.competitor_count) *
                        (data.new_products_this_month / 10 + 1);

  const gap_score = demand_signal / (supply_signal + 0.1);

  return {
    gap_score,
    opportunity_level: gap_score > 2 ? 'HIGH' : gap_score > 1 ? 'MEDIUM' : 'LOW',
    insight: generateInsight(data, gap_score)
  };
}
```

### Avtomatik scan (daily cron)
```typescript
// Har kuni barcha kategoriyalar uchun gap hisoblanadi
// gap_score > 2 bo'lsa ‚Üí email/Telegram alert
```

### DB
```sql
CREATE TABLE demand_supply_gaps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category_id BIGINT NOT NULL,
  gap_score DECIMAL(8,4),
  opportunity_level VARCHAR(10),
  orders_growth_pct DECIMAL(8,2),
  competitor_count INT,
  insight TEXT,
  calculated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## FEATURE 20 ‚Äî PRICE ELASTICITY CALCULATOR

### Nima?
Narx o'zgarganda `ordersQuantity` qanchalik o'zgarishi ‚Äî tarixiy snapshot dan hisoblash.

### Elasticity formulasi
```typescript
// Price elasticity of demand: Ed = (ŒîQ/Q) / (ŒîP/P)
function calculateElasticity(snapshots: Snapshot[]): ElasticityResult {
  const priceChanges: {dP_pct: number, dQ_pct: number}[] = [];

  for (let i = 1; i < snapshots.length; i++) {
    const prev = snapshots[i-1];
    const curr = snapshots[i];

    const dP = (curr.sell_price - prev.sell_price) / prev.sell_price;
    const dQ = (curr.orders_delta - prev.orders_delta) / (prev.orders_delta || 1);

    if (Math.abs(dP) > 0.02) { // 2%+ narx o'zgarishi bo'lganda
      priceChanges.push({ dP_pct: dP * 100, dQ_pct: dQ * 100 });
    }
  }

  if (priceChanges.length === 0) return { elasticity: null, confidence: 'LOW' };

  const avg_elasticity = avg(priceChanges.map(p => p.dQ_pct / p.dP_pct));

  return {
    elasticity: avg_elasticity,
    interpretation: avg_elasticity < -1 ? 'ELASTIC' : 'INELASTIC',
    // ELASTIC: narx o'zgartirish sotuvga kuchli ta'sir qiladi
    // INELASTIC: narx o'zgartirish kam ta'sir qiladi
    optimal_price_suggestion: calculateOptimalPrice(snapshots, avg_elasticity),
    confidence: priceChanges.length >= 5 ? 'HIGH' : 'MEDIUM'
  };
}
```

### UI
- Scatter plot: narx o'zgarishi vs sotuv o'zgarishi
- "Narxni 10% pasaytirsangiz, sotuvingiz ~23% o'sishi kutilmoqda"
- Optimal narx calculator slider

---

## v2.0 DELIVERY CHECKLIST

```
‚úÖ Feature 11: ML Prediction (linear regression, Recharts)
‚úÖ Feature 12: Auto Description Generator (Claude API)
‚úÖ Feature 13: Review Sentiment Analysis (batch + cache)
‚úÖ Feature 14: White-label (custom domain + theming)
‚úÖ Feature 16: PWA (manifest + service worker + push)
‚úÖ Feature 17: WebSocket (Socket.io + NestJS Gateway)
‚úÖ Feature 18: i18n (uz/ru/en, react-i18next)
‚úÖ Feature 19: Demand-Supply Gap (daily cron + alerts)
‚úÖ Feature 20: Price Elasticity (tarixiy snapshot tahlil)
```

---
*v2.0 | Features 11-20 | Faza 2-3 uchun*