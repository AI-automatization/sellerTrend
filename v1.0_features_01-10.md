# UZUM TREND FINDER ‚Äî v1.0
# FEATURES 01‚Äì10: CORE MVP + HIGH VALUE
# Claude CLI uchun to'liq texnik tavsif

> Bu versiya loyihaning asosi. Barcha keyingi versiyalar shu poydevor ustiga quriladi.
> Har bir feature uchun: Nima, Nima uchun, Qanday, DB, API, UI ‚Äî barchasi bor.

---

## ASOSIY ARXITEKTURA (barcha versiyalar uchun)

```
Monorepo: pnpm workspaces + Turborepo
‚îú‚îÄ‚îÄ apps/api      ‚Üí NestJS + Prisma + PostgreSQL
‚îú‚îÄ‚îÄ apps/worker   ‚Üí BullMQ + Redis
‚îî‚îÄ‚îÄ apps/web      ‚Üí React + Vite + Tailwind + Recharts

Uzum API: POST https://graphql.uzum.uz/
Rate limit: 1-2 req/sec | Proxy: residential rotation (MVP dan)
Narx birligi: —Å—É–º (tiyin EMAS) ‚Äî 46990 = 46,990 —Å—É–º
```

---

## FEATURE 01 ‚Äî COMPETITOR PRICE TRACKER

### Nima?
Bir xil mahsulot bir nechta shop tomonidan sotilayotganda ‚Äî barchaning narxini real vaqtda solishtirish.

### Nima uchun muhim?
Sotuvchi savol beradi: "Mening narxim bozordagi eng past narxmi? Raqibim qachon narxini o'zgartiradi?"

### Qanday ishlaydi?
1. `makeSearch` query da bir xil `title` yoki `characteristicValues` bilan bir nechta shop topiladi
2. Har shop uchun `minSellPrice`, `minFullPrice`, `discount` kuzatiladi
3. Snapshot har 6 soatda olinadi
4. Narx o'zgarganda alert

### DB (qo'shimcha jadvallar)
```sql
CREATE TABLE competitor_price_snapshots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id BIGINT REFERENCES products(id),
  shop_id BIGINT REFERENCES shops(id),
  sell_price BIGINT NOT NULL,
  full_price BIGINT NOT NULL,
  discount_percent INT,
  is_best_price BOOLEAN,
  snapshot_at TIMESTAMPTZ DEFAULT NOW()
);

-- View: eng arzon narx
CREATE VIEW product_price_competition AS
SELECT
  p.id as product_id,
  p.title,
  MIN(cps.sell_price) as min_market_price,
  MAX(cps.sell_price) as max_market_price,
  COUNT(DISTINCT cps.shop_id) as competitor_count,
  AVG(cps.sell_price) as avg_market_price
FROM products p
JOIN competitor_price_snapshots cps ON cps.product_id = p.id
WHERE cps.snapshot_at > NOW() - INTERVAL '24 hours'
GROUP BY p.id, p.title;
```

### API Endpoints
```
GET /api/products/:id/competitors
‚Üí { competitors: [{shop, price, rank, delta_from_min}] }

GET /api/products/:id/price-history?days=7
‚Üí { snapshots: [{date, min_price, max_price, my_price}] }
```

### UI
- Jadval: Shop nomi | Narx | Farq (%) | O'zgarish (‚Üë‚Üì) | So'nggi yangilanish
- Grafik: 7 kunlik narx dinamikasi (Recharts LineChart)
- Badge: "Siz eng arzon" / "Siz eng qimmat" / "O'rtacha"

### Uzum GraphQL query
```graphql
query makeSearch($queryInput: SearchQueryInput!) {
  makeSearch(query: $queryInput) {
    items {
      catalogCard {
        ... on SkuGroupCard {
          id
          productId
          minSellPrice
          minFullPrice
          buyingOptions { isBestPrice }
          discount { fullDiscountPercent }
        }
      }
    }
  }
}
```

---

## FEATURE 02 ‚Äî SEASONAL TREND CALENDAR

### Nima?
O'zbekistondagi muhim sanalar va mavsumlar uchun qaysi kategoriyalar qachon ko'tariladi ‚Äî vizual calendar.

### Muhim sanalar ro'yxati
```typescript
const UZ_SEASONS = [
  { name: "Ramazon", months: [3, 4], impact: "Oziq-ovqat, atir, sovg'a" },
  { name: "Yangi yil (Navro'z)", months: [3], impact: "Kiyim, uy jihozlari" },
  { name: "8-mart", months: [3], impact: "Parfyumeriya, gullar, kosmetika" },
  { name: "Maktab mavsumi", months: [8, 9], impact: "Daftar, sumka, kiyim" },
  { name: "Qish mavsumi", months: [11, 12, 1], impact: "Isitish, kiyim, oziq" },
  { name: "Yoz mavsumi", months: [6, 7, 8], impact: "Konditsioner, ichimlik" },
  { name: "Yangi yil (1-yanvar)", months: [12, 1], impact: "Sovg'a, bezak, oziq" }
];
```

### Qanday ishlaydi?
1. `product_snapshots` tarixidan kategoriya bo'yicha `ordersQuantity` delta hisoblanadi
2. Har oy uchun o'rtacha o'sish % aniqlanadi
3. Heatmap ko'rinishida ko'rsatiladi

### DB
```sql
CREATE TABLE seasonal_trends (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category_id BIGINT NOT NULL,
  month INT NOT NULL,                    -- 1-12
  year INT NOT NULL,
  avg_orders_growth_pct DECIMAL(8,2),   -- o'tgan oyga nisbatan %
  avg_price_change_pct DECIMAL(8,2),
  top_product_ids BIGINT[],
  calculated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API
```
GET /api/trends/seasonal?category_id=66&year=2025
‚Üí { months: [{month, growth_pct, top_products, season_label}] }

GET /api/trends/upcoming
‚Üí Keyingi 30 kun ichida kutilayotgan ko'tarilishlar
```

### UI
- 12 oylik heatmap (qizil = ko'p o'sish, yashil = pasayish)
- "Kelayotgan mavsumlar" widget ‚Äî dashboard da doim ko'rinadi
- Kategoriya bo'yicha filter

---

## FEATURE 03 ‚Äî SHOP INTELLIGENCE DASHBOARD

### Nima?
Har bir Uzum shop uchun to'liq analitik profil: kuch, zaiflik, o'sish dinamikasi.

### Ma'lumotlar manbai
```typescript
// Shop data Uzum dan olinadi:
interface ShopProfile {
  id: number;
  title: string;
  rating: number;
  totalProducts: number;
  ordersQuantity: number;   // shop umumiy buyurtmalari
  registeredAt: string;
  // Bizda qo'shimcha hisoblaymiz:
  avgProductScore: number;
  topCategories: string[];
  weeklyGrowthPct: number;
  trustScore: number;       // bizning formula
}
```

### Trust Score formulasi
```typescript
function calculateTrustScore(shop: ShopProfile): number {
  return (
    0.30 * normalize(shop.rating, 1, 5) +
    0.25 * normalize(shop.totalProducts, 1, 1000) +
    0.25 * normalize(shop.ordersQuantity, 0, 100000) +
    0.20 * normalize(ageInDays(shop.registeredAt), 0, 1095) // 3 yil max
  );
}
```

### DB
```sql
CREATE TABLE shop_snapshots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  shop_id BIGINT REFERENCES shops(id),
  total_products INT,
  total_orders BIGINT,
  rating DECIMAL(3,2),
  trust_score DECIMAL(5,4),
  snapshot_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API
```
GET /api/shops/:id/profile
GET /api/shops/:id/products?sort=score&limit=20
GET /api/shops/:id/growth?days=30
GET /api/shops/compare?ids=123,456,789
```

### UI
- Shop karta: Logo | Rating | Trust Score badge | Mahsulotlar soni
- Grafik: Oylik o'sish (buyurtmalar dinamikasi)
- "Top raqiblar" bo'limi ‚Äî bir kategoriyada eng kuchli shoplar

---

## FEATURE 04 ‚Äî NICHE FINDER

### Nima?
`ordersQuantity` yuqori lekin `feedbackQuantity` past ‚Äî bozorga yangi kirish imkoniyati.

### Mantiq
```
Yuqori orders + Past reviews = Bozor to'yinmagan, mahsulot sotilmoqda
                                lekin raqobat hali kuchli emas
```

### Niche Score formulasi
```typescript
function nicheScore(product: {
  orders_quantity: number;
  feedback_quantity: number;
  competitor_count: number;
  avg_competitor_price: number;
}): number {
  const demand = Math.log(1 + product.orders_quantity);
  const competition = Math.log(1 + product.feedback_quantity);
  const saturation = Math.log(1 + product.competitor_count);

  return demand / (competition * 0.6 + saturation * 0.4 + 1);
}
```

### Filtrlar
```typescript
interface NicheFinderFilters {
  min_orders: number;          // default: 500
  max_reviews: number;         // default: 100
  max_competitors: number;     // default: 10
  category_id?: number;
  price_range?: [number, number]; // —Å—É–º
  min_niche_score?: number;
}
```

### API
```
GET /api/niche-finder?min_orders=500&max_reviews=100&category_id=66
‚Üí {
    niches: [{
      product_id, title, niche_score,
      orders_quantity, feedback_quantity,
      competitor_count, avg_price,
      opportunity_label: "üî• Yuqori imkoniyat"
    }]
  }
```

### UI
- Karta ko'rinishida: Niche score progress bar | Orders vs Reviews nisbati
- "Imkoniyat darajasi": Yuqori / O'rta / Past (rangli badge)
- Eksport: CSV ga yuklab olish

---

## FEATURE 05 ‚Äî CSV/EXCEL IMPORT & EXPORT

### Nima?
Foydalanuvchi o'z mahsulotlar ro'yxatini yuklaydi ‚Üí batch analyze ‚Üí natijani yuklab olish.

### Import format
```csv
product_url,my_price,my_cost
https://uzum.uz/product/18332,21990,12000
https://uzum.uz/product/106839,46990,30000
```

### Qanday ishlaydi?
```typescript
// apps/api/src/import/import.service.ts
async processCsvImport(file: Buffer, accountId: string) {
  const rows = parseCsv(file);

  // BullMQ queue ga batch job
  const job = await this.importQueue.add('batch-analyze', {
    rows,
    accountId,
    importId: uuid()
  });

  return { jobId: job.id, total: rows.length };
}

// Worker: har URL uchun Uzum dan data olish
async processRow(row: ImportRow) {
  const productId = extractProductId(row.product_url);
  const uzumData = await this.uzumClient.fetchProductDetail(productId);
  const score = calculateScore(uzumData);

  return {
    ...row,
    uzum_price: uzumData.minSellPrice,
    score,
    weekly_bought: uzumData.weekly_bought,
    margin_pct: ((row.my_price - row.my_cost) / row.my_price * 100).toFixed(1)
  };
}
```

### Export format (Excel)
```
Mahsulot | Uzum narxi | Mening narxim | Score | Weekly bought | Margin% | Raqiblar soni
```

### DB
```sql
CREATE TABLE import_jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID REFERENCES accounts(id),
  status VARCHAR(50) DEFAULT 'PENDING',  -- PENDING|PROCESSING|DONE|FAILED
  total_rows INT,
  processed_rows INT DEFAULT 0,
  file_name VARCHAR(255),
  result_url TEXT,                       -- S3/CDN link
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API
```
POST /api/import/csv          ‚Üí multipart/form-data
GET  /api/import/:jobId/status ‚Üí {status, processed, total, pct}
GET  /api/import/:jobId/download ‚Üí Excel file stream
```

---

## FEATURE 06 ‚Äî REFERRAL TIZIMI

### Nima?
Foydalanuvchi referal link orqali yangi user olib kelsa ‚Üí ikkalasiga 7 kunlik bepul obuna.

### DB
```sql
CREATE TABLE referrals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  referrer_account_id UUID REFERENCES accounts(id),
  referred_account_id UUID REFERENCES accounts(id),
  status VARCHAR(50) DEFAULT 'PENDING',  -- PENDING|ACTIVATED|REWARDED
  reward_days INT DEFAULT 7,
  activated_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE accounts ADD COLUMN referral_code VARCHAR(20) UNIQUE;
ALTER TABLE accounts ADD COLUMN free_days_remaining INT DEFAULT 0;
```

### Logika
```typescript
// Kunlik charge cron da tekshiriladi:
async function getEffectiveFee(account: Account): Promise<bigint> {
  if (account.free_days_remaining > 0) {
    await prisma.account.update({
      where: { id: account.id },
      data: { free_days_remaining: { decrement: 1 } }
    });
    return BigInt(0); // bepul kun
  }
  return account.daily_fee ?? await getGlobalDailyFee();
}
```

### API
```
GET  /api/referral/my-code     ‚Üí {code, link, total_referrals, earned_days}
POST /api/referral/activate    ‚Üí {code} ‚Üí aktivatsiya
GET  /api/referral/history     ‚Üí [{referred_user, date, status}]
```

---

## FEATURE 07 ‚Äî API ACCESS (DEVELOPER PLAN)

### Nima?
Sotuvchilarning o'z tizimlariga bizning ma'lumotlarni API orqali ulash. Alohida tarif rejasi.

### API Key tizimi
```sql
CREATE TABLE api_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID REFERENCES accounts(id),
  key_hash VARCHAR(64) UNIQUE NOT NULL,   -- SHA-256 hash
  key_prefix VARCHAR(8) NOT NULL,         -- ko'rsatish uchun: "utf_a1b2"
  name VARCHAR(100),
  rate_limit_per_hour INT DEFAULT 100,
  is_active BOOLEAN DEFAULT TRUE,
  last_used_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Rate limiting
```typescript
// Redis da: key:account_id:hour ‚Üí count
async function checkRateLimit(apiKey: ApiKey): Promise<boolean> {
  const redisKey = `ratelimit:${apiKey.account_id}:${getCurrentHour()}`;
  const count = await redis.incr(redisKey);
  await redis.expire(redisKey, 3600);
  return count <= apiKey.rate_limit_per_hour;
}
```

### Public API endpoints
```
GET /public/v1/products/:id/score
GET /public/v1/products/:id/snapshots?days=7
GET /public/v1/categories/:id/winners?limit=20
GET /public/v1/niche-finder?min_orders=500
```

### Tarif rejalari
```typescript
const API_PLANS = {
  BASIC:      { req_per_hour: 100,  monthly_price: 200_000 },
  PRO:        { req_per_hour: 1000, monthly_price: 500_000 },
  ENTERPRISE: { req_per_hour: 10000, monthly_price: 2_000_000 }
};
```

---

## FEATURE 08 ‚Äî PUBLIC LEADERBOARD (FREEMIUM)

### Nima?
Ro'yxatdan o'tmasdan ham har kategoriyada top-5 mahsulotni ko'rish. Lead generation.

### Freemium cheklovlar
```typescript
const FREEMIUM_LIMITS = {
  top_visible: 5,        // faqat top 5 ko'rinadi
  refresh_hours: 24,     // har 24 soatda yangilanadi (pro: real-time)
  score_hidden: true,    // score raqami ko'rinmaydi
  weekly_bought_hidden: true  // aniq raqamlar yashiriladi
};
```

### DB
```sql
CREATE TABLE public_leaderboard (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category_id BIGINT NOT NULL,
  product_id BIGINT REFERENCES products(id),
  rank INT NOT NULL,
  score DECIMAL(8,4),
  score_badge VARCHAR(20),   -- "üî• Juda issiq" / "üìà O'smoqda"
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API (auth kerak emas)
```
GET /public/leaderboard/:category_id
‚Üí {
    category: {id, title},
    products: [{rank, title, photo_url, score_badge, price}],  // top 5
    last_updated: "2025-02-22T10:00:00Z",
    total_tracked: 3381,
    cta: "To'liq ro'yxatni ko'rish uchun ro'yxatdan o'ting"
  }
```

### SEO sahifalar
```
/leaderboard/krasota-i-uhod     ‚Üí –ö—Ä–∞—Å–æ—Ç–∞ –∏ —É—Ö–æ–¥ top mahsulotlar
/leaderboard/produkty-pitaniya  ‚Üí Oziq-ovqat top mahsulotlar
```
Google indekslanadi ‚Üí organic traffic ‚Üí free lead generation.

---

## FEATURE 09 ‚Äî PROFIT CALCULATOR 2.0

### Nima?
Uzum komissiyasi + yetkazib berish + reklama + o'z xarajat ‚Üí sof foyda kalkulyatori.

### Uzum komissiya tizimi (ma'lum bo'lgan)
```typescript
const UZUM_COMMISSION = {
  // Kategoriya bo'yicha komissiya (taxminiy, tekshirib ko'ring)
  default: 0.15,          // 15%
  electronics: 0.08,      // 8%
  clothing: 0.18,         // 18%
  beauty: 0.20,           // 20%
  food: 0.12,             // 12%
  fbo_fee_per_kg: 3000,   // —Å—É–º/kg ombor xizmati
};
```

### Kalkulyator formulasi
```typescript
interface ProfitInput {
  sell_price: number;          // Uzum da sotish narxi
  purchase_price: number;      // sotib olish narxi (–∏–ª–∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å)
  weight_kg: number;           // og'irlik
  category_id: number;
  monthly_units: number;       // oylik taxminiy sotish
  ads_budget_monthly: number;  // reklama byudjeti
}

function calculateProfit(input: ProfitInput): ProfitResult {
  const commission = input.sell_price * UZUM_COMMISSION[category];
  const fbo_fee = input.weight_kg * UZUM_COMMISSION.fbo_fee_per_kg;
  const revenue = input.sell_price * input.monthly_units;
  const cogs = input.purchase_price * input.monthly_units;
  const total_commission = commission * input.monthly_units;
  const total_fbo = fbo_fee * input.monthly_units;

  const net_profit = revenue - cogs - total_commission - total_fbo - input.ads_budget_monthly;
  const margin_pct = (net_profit / revenue) * 100;
  const roi = (net_profit / (cogs + input.ads_budget_monthly)) * 100;

  return { revenue, cogs, commission: total_commission, fbo: total_fbo,
           net_profit, margin_pct, roi, breakeven_units: Math.ceil(
             (cogs + input.ads_budget_monthly) / (input.sell_price - commission - fbo_fee)
           )};
}
```

### UI
- Slider'lar: narx, miqdor, reklama byudjeti
- Real-time hisoblash (debounced)
- Pie chart: revenue taqsimoti
- "Optimal narx" tavsiya: margin 20%+ uchun minimum narx

---

## FEATURE 10 ‚Äî BROWSER EXTENSION

### Nima?
Chrome/Firefox kengaytmasi. Uzum sahifasida turgan foydalanuvchi mahsulot yonida bizning score ni ko'radi.

### Texnik arxitektura
```
Chrome Extension (Manifest V3)
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ content.js      ‚Üí Uzum sahifasiga inject bo'ladi
‚îú‚îÄ‚îÄ background.js   ‚Üí API so'rovlar
‚îî‚îÄ‚îÄ popup.html      ‚Üí mini dashboard
```

### content.js
```javascript
// Uzum product page da product ID ni olish
function getProductId() {
  const match = window.location.pathname.match(/\/product\/(\d+)/);
  return match ? match[1] : null;
}

// Bizning API dan score olish
async function injectScore(productId) {
  const data = await chrome.runtime.sendMessage({
    type: 'GET_SCORE',
    productId
  });

  // Uzum sahifasiga score badge qo'shish
  const priceBlock = document.querySelector('[data-test="product-price"]');
  if (priceBlock && data.score) {
    const badge = document.createElement('div');
    badge.className = 'utf-score-badge';
    badge.innerHTML = `
      <span>üî• UTF Score: ${data.score.toFixed(2)}</span>
      <span>üì¶ Weekly: ${data.weekly_bought ?? '?'}</span>
      <span>üìä Rank: #${data.category_rank}</span>
    `;
    priceBlock.after(badge);
  }
}
```

### Auth
Extension localStorage da JWT token saqlaydi ‚Üí bizning API ga authenticated so'rov.

### Distribution
- Chrome Web Store da publish
- Firefox Add-ons da publish
- Bizning dashboard dan "Extension yuklab olish" tugmasi

---

## FAZA 1 DELIVERY CHECKLIST (v1.0)

```
‚úÖ Monorepo setup (turborepo + pnpm)
‚úÖ PostgreSQL + Redis docker-compose
‚úÖ Prisma schema (asosiy 12 jadval + feature jadvallar)
‚úÖ NestJS API skeleton
‚úÖ Auth: JWT login/register/refresh
‚úÖ Uzum GraphQL client (makeSearch + productPage)
‚úÖ Scoring engine (weekly_bought parser + formula)
‚úÖ URL Analyze flow (end-to-end)
‚úÖ Billing: daily charge cron + 402 middleware
‚úÖ Feature 01: Competitor Price Tracker
‚úÖ Feature 04: Niche Finder
‚úÖ Feature 08: Public Leaderboard
‚úÖ Feature 09: Profit Calculator UI
‚úÖ Basic React dashboard
‚úÖ Feature 05: CSV Import (basic)
```

---
*v1.0 | Features 01-10 | Faza 1-2 uchun*