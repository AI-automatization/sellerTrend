# UZUM TREND FINDER â€” v4.0
# FEATURES 31â€“42 + YANGI: XITOY/EVROPA NARX TAQQOSLASH + CARGO KALKULYATOR
# Claude CLI uchun to'liq texnik tavsif

> v1.0 + v2.0 + v3.0 ustiga quriladi. Bu versiya loyihaning "moat" qismini yaratadi.

---

## FEATURE 31 â€” UZUM ADS ROI TRACKER

### Nima?
Reklama xarajati + mahsulot sotuvi o'zgarishi â†’ reklama qaytimini hisoblash.

### Qanday ishlaydi?
```typescript
// Foydalanuvchi Uzum reklama xarajatini qo'lda kiritadi (Uzum API bu ma'lumotni bermaydi)
// Tizim sotuv o'zgarishini kuzatadi va hisoblab beradi

interface AdsTracking {
  product_id: number;
  ads_start_date: Date;
  ads_end_date?: Date;
  daily_budget: number;        // ÑÑƒĞ¼/kun
  total_spent: number;         // umumiy xarajat
  orders_before: number;       // reklama oldin o'rtacha kunlik
  orders_during: number;       // reklama davomida o'rtacha kunlik
  orders_after: number;        // reklama tugagandan keyin
}

function calculateAdsRoi(tracking: AdsTracking, avgOrderValue: number): AdsRoiResult {
  const incremental_orders = tracking.orders_during - tracking.orders_before;
  const incremental_revenue = incremental_orders * avgOrderValue * getDays(tracking);
  const roi_pct = ((incremental_revenue - tracking.total_spent) / tracking.total_spent) * 100;
  const cac = tracking.total_spent / (incremental_orders * getDays(tracking)); // cost per order

  return {
    roi_pct,
    cac,                        // Har bir buyurtma uchun reklama xarajati
    incremental_revenue,
    payback_days: tracking.total_spent / (incremental_revenue / getDays(tracking)),
    verdict: roi_pct > 100 ? 'PROFITABLE' : roi_pct > 0 ? 'BREAKEVEN' : 'LOSS',
    recommendation: generateAdsRecommendation(roi_pct, cac)
  };
}
```

### DB
```sql
CREATE TABLE ads_campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID REFERENCES accounts(id),
  product_id BIGINT REFERENCES products(id),
  name VARCHAR(255),
  daily_budget BIGINT,
  started_at TIMESTAMPTZ,
  ended_at TIMESTAMPTZ,
  status VARCHAR(20) DEFAULT 'ACTIVE',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE ads_daily_spend (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES ads_campaigns(id),
  date DATE NOT NULL,
  spent BIGINT,
  orders_count INT,             -- o'sha kunda sotuv (snapshot dan)
  UNIQUE(campaign_id, date)
);
```

---

## FEATURE 32 â€” TELEGRAM MINI APP

### Nima?
To'liq web app emas â€” Telegram ichida ishlaydi. O'zbekistonda Telegram penetratsiyasi 90%+.

### Arxitektura
```typescript
// Telegram Bot API + WebApp
// apps/telegram-miniapp (React + Vite)

// Bot tomonidan ochiladi:
// /start â†’ "Dashboardni oching" tugmasi â†’ WebApp ochiladi

// Telegram WebApp API
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand(); // to'liq ekran

// Auth: Telegram user ID orqali (JWT exchange)
const initData = tg.initData; // Telegram signed data
// Backend da verifikatsiya:
async function verifyTelegramAuth(initData: string): Promise<User> {
  const hash = computeHmac(initData, process.env.BOT_TOKEN);
  // hash to'g'ri bo'lsa â†’ JWT chiqariladi
}
```

### Mini App sahifalari
```
/           â†’ Dashboard (top 5 tracked products)
/leaderboard â†’ Kategoriya liderlar
/alerts     â†’ Oxirgi alertlar
/profit     â†’ Profit calculator (soddalashtirilgan)
```

### Bot commands
```
/start      â†’ Mini App ochish
/alert      â†’ Oxirgi alertlar
/top        â†’ Bugungi top mahsulotlar
/price {URL} â†’ Tez narx tekshirish
```

### grammY bot setup
```typescript
import { Bot, webhookCallback } from 'grammy';

const bot = new Bot(process.env.TELEGRAM_BOT_TOKEN!);

bot.command('start', async (ctx) => {
  await ctx.reply('Uzum Trend Finder ga xush kelibsiz!', {
    reply_markup: {
      inline_keyboard: [[{
        text: 'ğŸ“Š Dashboardni oching',
        web_app: { url: process.env.MINIAPP_URL! }
      }]]
    }
  });
});

// Webhook (serverless uchun yaxshi)
export const POST = webhookCallback(bot, 'std/http');
```

---

## FEATURE 36 â€” TEAM COLLABORATION

### Nima?
Bir account da bir nechta user, rollar bo'yicha huquqlar. Agentliklar uchun muhim.

### Rol tizimi
```typescript
enum TeamRole {
  OWNER   = 'OWNER',    // Billing, member boshqarish, hamma narsa
  ADMIN   = 'ADMIN',    // Hamma narsa, billing emas
  ANALYST = 'ANALYST',  // Ko'rish + export, o'zgartirish yo'q
  VIEWER  = 'VIEWER'    // Faqat ko'rish
}

const ROLE_PERMISSIONS: Record<TeamRole, string[]> = {
  OWNER:   ['*'],
  ADMIN:   ['read', 'write', 'delete', 'export', 'alerts'],
  ANALYST: ['read', 'export', 'alerts'],
  VIEWER:  ['read']
};
```

### DB
```sql
CREATE TABLE team_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID REFERENCES accounts(id),
  user_id UUID REFERENCES users(id),
  role VARCHAR(20) NOT NULL,
  invited_by UUID REFERENCES users(id),
  accepted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(account_id, user_id)
);

CREATE TABLE team_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID REFERENCES accounts(id),
  email VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL,
  token VARCHAR(64) UNIQUE NOT NULL,
  expires_at TIMESTAMPTZ,
  accepted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API
```
POST /api/team/invite         â†’ email + role
GET  /api/team/members        â†’ member ro'yxati
PUT  /api/team/members/:id    â†’ rol o'zgartirish
DELETE /api/team/members/:id  â†’ chiqarish
GET  /api/team/invitations    â†’ pending invite'lar
```

---

## FEATURE 37 â€” CUSTOM REPORT BUILDER

### Nima?
Drag-and-drop bilan o'z hisobotingni yasat â†’ PDF/Excel export.

### Report blocks (widget'lar)
```typescript
type ReportBlock =
  | { type: 'score_chart';     product_ids: number[]; period_days: number }
  | { type: 'price_table';     product_ids: number[] }
  | { type: 'top_products';    category_id: number; limit: number }
  | { type: 'niche_table';     filters: NicheFinderFilters }
  | { type: 'competitor_grid'; product_id: number }
  | { type: 'text';            content: string }
  | { type: 'profit_summary';  product_ids: number[] };

interface ReportTemplate {
  id: string;
  account_id: string;
  name: string;
  blocks: ReportBlock[];
  schedule?: 'WEEKLY' | 'MONTHLY';  // avtomatik yuborish
  recipients?: string[];            // email yoki Telegram
}
```

### PDF generatsiya (Puppeteer)
```typescript
async function generatePdf(reportId: string): Promise<Buffer> {
  const report = await buildReportHtml(reportId);

  const browser = await puppeteer.launch({ headless: true });
  const page = await browser.newPage();
  await page.setContent(report.html);

  const pdf = await page.pdf({
    format: 'A4',
    printBackground: true,
    margin: { top: '20mm', bottom: '20mm' }
  });

  await browser.close();
  return pdf;
}
```

---

## FEATURE 38 â€” MARKET SHARE REPORT (WHITE-LABEL PDF)

### Nima?
Har oyda avtomatik: "Sizning kategoriyangizda bu oy nima bo'ldi" â€” PDF formatida.

### Tarkib
```
1. Executive Summary (Claude tomonidan yoziladi)
2. Kategoriya o'sish dinamikasi (grafik)
3. Top 10 mahsulot (jadval)
4. Narx tendensiyalari
5. Yangi kiruvchilar
6. Raqiblar harakati
7. Keyingi oy uchun tavsiyalar (Claude)
```

### Avtomatik yuborish
```typescript
@Cron('0 9 1 * *') // Har oyning 1-kuni 09:00
async monthlyReportCron() {
  const accounts = await getWhiteLabelAccounts();
  for (const account of accounts) {
    const pdf = await generateMonthlyReport(account);
    await sendViaEmail(account, pdf);
    await sendViaTelegram(account, pdf);
  }
}
```

---

## FEATURE 39 â€” WATCHLIST SHARING

### Nima?
"Mening kuratirovka qilgan mahsulotlar ro'yxatim" â†’ public link orqali ulashing.

### DB
```sql
CREATE TABLE shared_watchlists (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID REFERENCES accounts(id),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  product_ids BIGINT[] NOT NULL,
  share_token VARCHAR(32) UNIQUE NOT NULL,
  is_public BOOLEAN DEFAULT TRUE,
  views_count INT DEFAULT 0,
  expires_at TIMESTAMPTZ,         -- NULL = muddatsiz
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Shareable URL
```
https://uzumtrend.uz/w/{share_token}
â†’ Public sahifa, auth kerak emas
â†’ Top 5 ochiq, qolganlar blur (login CTA)
```

---

## FEATURE 40 â€” HISTORICAL DATA ARCHIVE (2+ YIL)

### Nima?
**Bu loyihaning eng kuchli raqobat ustunligi.** Hech kim Uzum data ni yillab saqlamagan.

### Muhimligi
```
Bugun boshlanmasa â†’ 1 yildan keyin 1 yillik tarix yo'q
Bugun boshlanÑĞ° â†’ 2 yildan keyin 2 yillik noyob data

Bu data SOTIB BO'LMAYDI â€” faqat vaqt bilan to'planadi.
```

### Retention strategiyasi
```sql
-- product_snapshots jadval partition by month
CREATE TABLE product_snapshots_2025_01 PARTITION OF product_snapshots
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- Eski data arxivlanadi (zstd compression)
-- Hot data: oxirgi 90 kun â†’ PostgreSQL
-- Warm data: 90-365 kun â†’ PostgreSQL (compressed)
-- Cold data: 1 yil+ â†’ S3/object storage
```

### Compression
```typescript
// TimescaleDB ishlatilsa yanada yaxshi (time-series uchun optimallashtirilgan)
// pg_partman extension bilan avtomatik partition
```

### Historical Query API
```
GET /api/products/:id/history?from=2024-01-01&to=2025-01-01&resolution=weekly
â†’ {snapshots: [{week, orders_qty, price, score, rank}]}

GET /api/categories/:id/yearly-trend?year=2024
â†’ {months: [{month, top_products, avg_score, total_volume}]}
```

---

## FEATURE 41 â€” COLLECTIVE INTELLIGENCE

### Nima?
1000+ sotuvchi bir platformada â†’ ularning umumiy behavioral pattern'i â†’ boshqalarga anonimlashtirilib ko'rsatiladi.

### Ma'lumotlar
```typescript
// Nima kuzatiladi (anonimlashtirilib):
// - Qaysi mahsulotlar ko'p watched
// - Qaysi categoriyalar most analyzed
// - Qaysi alert types most triggered
// - Batch import trending searches

// Privacy: account_id â†’ hashed, faqat aggregate ko'rsatiladi
interface CollectiveSignal {
  product_id: number;
  watchers_count: number;      // nechta account kuzatmoqda (anonimlashtrilgan)
  trend_velocity: number;      // oxirgi 24 soatda kuzatuvchilar o'sishi
  collective_score: number;    // community + bizning score kombinatsiyasi
}
```

### "Trending Now" widget
```typescript
// Oxirgi 24 soatda eng ko'p watched qo'shilgan mahsulotlar
// "ğŸ”¥ 127 sotuvchi bu mahsulotni kuzatyapti"
// Bu social proof â†’ konversiya oshadi
```

### DB
```sql
CREATE TABLE product_watch_aggregate (
  product_id BIGINT PRIMARY KEY REFERENCES products(id),
  watchers_count INT DEFAULT 0,
  new_watchers_24h INT DEFAULT 0,
  collective_score DECIMAL(8,4),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## FEATURE 42 â€” UZUM ALGORITHM REVERSE ENGINEERING

### Nima?
Qaysi mahsulotlar qidiruv sahifasida yuqori chiqadi? Uzum ranking algoritmini aniqlash.

### Metodologiya
```typescript
// 1. Har snapshot da mahsulot POSITION ni saqlang (Feature 27)
// 2. O'zgaruvchilar va pozitsiya o'rtasidagi korrelyatsiyani hisoblang

interface RankingFactors {
  position: number;
  orders_quantity: number;
  feedback_quantity: number;
  rating: number;
  sell_price: number;
  discount_pct: number;
  is_fbo: boolean;
  is_best_price: boolean;
  badge_count: number;
  photos_count: number;
  days_since_listed: number;
  weekly_bought: number;
}

// Multiple regression: qaysi faktor pozitsiyaga ko'p ta'sir qiladi?
function analyzeRankingFactors(data: RankingFactors[]): FactorImportance[] {
  // Regression coefficients â†’ faktor ahamiyati
  // Output: [{factor: 'rating', importance: 0.35}, {factor: 'orders', importance: 0.28}]
}
```

### Yig'ilgan bilimlar (to'planib boradi)
```typescript
// 10,000+ snapshot dan olingan xulosalar:
const KNOWN_RANKING_FACTORS = {
  rating_weight: 0.30,          // taxminiy
  orders_velocity_weight: 0.25, // taxminiy
  fbo_bonus: true,              // FBO mahsulotlar yuqoriroq
  best_price_bonus: true,       // isBestPrice = yuqoriroq pozitsiya
  review_recency: true,         // yangi reviewlar muhim
};
```

### "Algorithm Insights" sahifasi
```
Uzum Ranking Algoritmimiz tadqiqotimiz asosida:
1. Rating (4.7+) â†’ +15% ko'tarilish ehtimoli
2. FBO status â†’ O'rtacha 8 pozitsiya yuqoriroq
3. Weekly bought o'sishi â†’ Tez ranking ko'tarilishi
4. 5+ foto â†’ 12% yuqoriroq o'rtacha pozitsiya
[yangilanadi: har oy]
```

---

## â­ YANGI FEATURE 43 â€” XITOY/EVROPA NARX TAQQOSLASH + CARGO KALKULYATOR

> Bu feature loyihaning eng differensiatsiya qiluvchi qismi.
> Uzum da mahsulot sotilmoqda â†’ Xitoy/Evropada xuddi shu narx qancha â†’ Kargo bilan olib kelish + foyda hisoblash.

### 43a. NARX TAQQOSLASH TIZIMI

#### Manbalar
```typescript
// XITOY OPTOVIY SAYTLAR:
const CHINA_SOURCES = [
  {
    name: '1688.com',
    type: 'WHOLESALE',
    currency: 'CNY',
    language: 'ZH',
    notes: 'Eng katta optoviy platforma. Narxlar juda past. Faqat Xitoy uchun.'
  },
  {
    name: 'Alibaba.com',
    type: 'WHOLESALE',
    currency: 'USD',
    language: 'EN',
    notes: 'Xalqaro optoviy. Minimum buyurtma bor (MOQ).'
  },
  {
    name: 'AliExpress.com',
    type: 'RETAIL',
    currency: 'USD',
    language: 'EN',
    notes: 'Chakana narxlar. Optoviy emas, lekin real narx referansi.'
  },
  {
    name: 'DHgate.com',
    type: 'WHOLESALE',
    currency: 'USD',
    language: 'EN',
    notes: 'O\'rta optoviy. MOQ past.'
  },
  {
    name: 'Made-in-China.com',
    type: 'WHOLESALE',
    currency: 'USD',
    language: 'EN',
    notes: 'Ishlab chiqaruvchilar to\'g\'ridan-to\'g\'ri.'
  }
];

// EVROPA SAYTLAR:
const EUROPE_SOURCES = [
  {
    name: 'Amazon.de',
    type: 'RETAIL',
    currency: 'EUR',
    language: 'DE',
    notes: 'Germaniya. Brendli mahsulotlar uchun referans.'
  },
  {
    name: 'Amazon.co.uk',
    type: 'RETAIL',
    currency: 'GBP',
    language: 'EN',
    notes: 'Britaniya bozori.'
  },
  {
    name: 'Wildberries.ru',
    type: 'RETAIL',
    currency: 'RUB',
    language: 'RU',
    notes: 'Rossiya marketplace. Narxlar Uzum bilan taqqoslanadi.'
  },
  {
    name: 'Ozon.ru',
    type: 'RETAIL',
    currency: 'RUB',
    language: 'RU',
    notes: 'Rossiya marketplace.'
  }
];
```

#### Narx qidirish strategiyasi
```typescript
// Usul 1: AI + Product Title â†’ Search Query
async function findExternalPrice(product: UzumProduct): Promise<ExternalPrices> {
  // Claude orqali search query yaratish
  const searchQuery = await generateSearchQuery(product.title, product.category);
  // â†’ "Svetocopy A4 500 sheets printer paper wholesale"

  // Usul 2: Scraperapi / Serpapi orqali Google Shopping
  const googleResults = await searchGoogleShopping(searchQuery);

  // Usul 3: To'g'ridan-to'g'ri sayt API (agar mavjud)
  const aliResults = await searchAliExpressApi(searchQuery);

  return normalizeResults([googleResults, aliResults]);
}

// Claude prompt: mahsulot nomidan search query yaratish
const SEARCH_QUERY_PROMPT = `
Uzum mahsuloti: "${product.title}"
Kategoriya: ${product.category}

Xitoy optoviy saytlarda qidirish uchun eng samarali inglizcha kalit so'zlar yozing.
Faqat JSON: {"query_en": "...", "query_zh": "...", "product_type": "..."}
`;
```

#### Scraping strategiyasi (qonuniy yondashuv)
```typescript
// Google Shopping API (SerpApi) â†’ pullik lekin qonuniy
// ScraperApi â†’ JavaScript render qiluvchi proxy
// Oxirgi chora: Playwright headless browser

async function scrapeAliExpressPrice(query: string): Promise<ScrapedProduct[]> {
  // SerpApi orqali:
  const results = await serpapi.search({
    engine: 'google_shopping',
    q: query + ' site:aliexpress.com',
    gl: 'cn',
    hl: 'en'
  });

  return results.shopping_results.map(r => ({
    source: 'AliExpress',
    title: r.title,
    price_usd: r.price,
    url: r.link,
    min_order: extractMoq(r.snippet)
  }));
}
```

#### DB
```sql
CREATE TABLE external_price_searches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id BIGINT REFERENCES products(id),
  search_query VARCHAR(500),
  source VARCHAR(50),             -- '1688', 'aliexpress', 'amazon_de'
  found_price DECIMAL(12,2),
  currency VARCHAR(5),
  price_usd DECIMAL(12,2),        -- USD ga konvertatsiya
  price_uzs BIGINT,               -- UZS ga konvertatsiya
  min_order_quantity INT,
  url TEXT,
  confidence DECIMAL(3,2),        -- 0-1: qanchalik to'g'ri match
  searched_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE currency_rates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  from_currency VARCHAR(5),
  to_currency VARCHAR(5),
  rate DECIMAL(15,6),
  fetched_at TIMESTAMPTZ DEFAULT NOW()
);
-- CNY, USD, EUR, GBP, RUB â†’ UZS kurslar har kuni yangilanadi
```

#### Valyuta konvertatsiyasi
```typescript
// API: https://api.exchangerate-api.com (bepul tier)
// Yoki: CBU (O'zbekiston Markaziy Banki) kursi

@Cron('0 10 * * *') // Har kuni 10:00
async updateCurrencyRates() {
  const rates = await fetchFromCbu(); // O'zbekiston rasmiy kursi
  await prisma.currencyRate.createMany({ data: rates });
}

function convertToUzs(amount: number, currency: string): number {
  const rate = getCachedRate(currency, 'UZS');
  return Math.round(amount * rate);
}
```

---

### 43b. CARGO KALKULYATOR

#### Kargo yo'nalishlari va xizmatlar
```typescript
const CARGO_ROUTES = {
  CHINA_UZ: {
    providers: [
      {
        name: "Ğ£Ğ·Ñ‚Ñ€Ğ°Ğ½ÑĞ°Ğ²Ñ‚Ğ¾ (rasmiy)",
        transit_days: 25,
        price_per_kg: 4.5,       // USD/kg
        price_per_cbm: 350,      // USD/mÂ³
        currency: 'USD',
        notes: "Hujjatlar to'liq kerak"
      },
      {
        name: "ĞšĞ°Ñ€Ğ³Ğ¾ Ğ­ĞºÑĞ¿Ñ€ĞµÑÑ",
        transit_days: 18,
        price_per_kg: 5.5,
        price_per_cbm: 420,
        currency: 'USD',
        notes: "Tez, ishonchli"
      },
      {
        name: "ĞĞ²Ğ¸Ğ° (ĞŸĞµĞºĞ¸Ğ½â†’Ğ¢Ğ°ÑˆĞºĞµĞ½Ñ‚)",
        transit_days: 5,
        price_per_kg: 6.5,
        currency: 'USD',
        notes: "Tez lekin qimmat. Kichik og'irlikda foydali."
      },
      {
        name: "Transcontainer (temir yo'l)",
        transit_days: 15,
        price_per_kg: 3.8,
        price_per_cbm: 280,
        currency: 'USD',
        notes: "Katta hajmda eng arzon"
      }
    ]
  },
  EUROPE_UZ: {
    providers: [
      {
        name: "ĞšĞ°Ñ€Ğ³Ğ¾ Ğ•Ğ²Ñ€Ğ¾Ğ¿Ğ° (Ğ°Ğ²Ñ‚Ğ¾)",
        transit_days: 14,
        price_per_kg: 3.5,
        price_per_cbm: 280,
        currency: 'USD',
        notes: "Germaniya, Polsha, Turkiya orqali"
      },
      {
        name: "ĞĞ²Ğ¸Ğ° Ğ•Ğ²Ñ€Ğ¾Ğ¿Ğ°â†’Ğ¢Ğ°ÑˆĞºĞµĞ½Ñ‚",
        transit_days: 3,
        price_per_kg: 8.0,
        currency: 'USD',
        notes: "Kichik partiyalar uchun"
      },
      {
        name: "Ğ¢ÑƒÑ€Ñ†Ğ¸Ñâ†’Ğ£Ğ·Ğ±ĞµĞºĞ¸ÑÑ‚Ğ°Ğ½ (Ğ°Ğ²Ñ‚Ğ¾)",
        transit_days: 10,
        price_per_kg: 4.0,
        price_per_cbm: 300,
        currency: 'USD',
        notes: "Yevropa mahsulotlari Turkiya orqali"
      }
    ]
  }
};
```

#### Cargo hisoblash formulasi
```typescript
interface CargoInput {
  origin: 'CHINA' | 'EUROPE';
  product_weight_kg: number;       // 1 dona og'irligi
  product_dimensions_cm: [number, number, number]; // uzunlik Ã— kenglik Ã— balandlik
  order_quantity: number;          // nechta dona buyurtma
  product_purchase_price_usd: number; // Xitoy/Yevropa da narxi (1 dona)
  cargo_provider: string;
}

interface CargoResult {
  // Hajm hisoblash
  volume_per_unit_cbm: number;
  total_volume_cbm: number;
  total_weight_kg: number;

  // Cargo xarajati (og'irlik yoki hajm â€” qaysi katta)
  chargeable_weight_kg: number;    // volumetric weight vs actual (katta biri)
  cargo_cost_usd: number;
  cargo_cost_per_unit_usd: number;

  // Bojxona
  customs_duty_pct: number;        // kategoriya bo'yicha bojxona stavkasi
  customs_cost_usd: number;
  vat_usd: number;                 // 12% QQS

  // Umumiy xarajat
  total_landed_cost_usd: number;   // purchase + cargo + customs + VAT
  total_landed_cost_uzs: bigint;
  cost_per_unit_uzs: bigint;

  // Uzum da sotuv tahlili
  uzum_sell_price_uzs: bigint;
  gross_margin_pct: number;
  net_margin_pct: number;          // Uzum komissiyasi chegirib
  roi_pct: number;
  breakeven_units: number;
  payback_days: number;

  // Tavsiya
  verdict: 'HIGHLY_PROFITABLE' | 'PROFITABLE' | 'BORDERLINE' | 'NOT_PROFITABLE';
  recommendation: string;
}

function calculateCargoLandedCost(input: CargoInput): CargoResult {
  const { product_weight_kg: w, product_dimensions_cm: [l, ww, h], order_quantity: qty } = input;

  // Volumetric weight (DIM factor: 5000 for air, 4000 for sea/road)
  const dim_factor = input.cargo_provider.includes('ĞĞ²Ğ¸Ğ°') ? 5000 : 4000;
  const volumetric_weight_per_unit = (l * ww * h) / dim_factor;
  const actual_weight = w * qty;
  const volumetric_weight = volumetric_weight_per_unit * qty;
  const chargeable_weight = Math.max(actual_weight, volumetric_weight);

  const provider = findProvider(input.origin, input.cargo_provider);
  const cargo_cost_usd = chargeable_weight * provider.price_per_kg;

  // O'zbekiston bojxona (kategoriya bo'yicha â€” taxminiy)
  const CUSTOMS_RATES: Record<string, number> = {
    electronics: 0.05,
    clothing: 0.20,
    cosmetics: 0.15,
    food: 0.10,
    furniture: 0.10,
    default: 0.10
  };
  const customs_rate = CUSTOMS_RATES[input.category] ?? CUSTOMS_RATES.default;
  const purchase_total_usd = input.product_purchase_price_usd * qty;
  const customs_cost_usd = purchase_total_usd * customs_rate;
  const vat_usd = (purchase_total_usd + cargo_cost_usd + customs_cost_usd) * 0.12;

  const total_landed_cost_usd = purchase_total_usd + cargo_cost_usd + customs_cost_usd + vat_usd;
  const total_landed_cost_uzs = convertToUzs(total_landed_cost_usd, 'USD');
  const cost_per_unit_uzs = total_landed_cost_uzs / qty;

  const uzum_commission = input.uzum_sell_price_uzs * 0.15;
  const revenue_per_unit = input.uzum_sell_price_uzs - uzum_commission;
  const gross_margin = (revenue_per_unit - cost_per_unit_uzs) / revenue_per_unit;
  const net_profit_total = (revenue_per_unit - cost_per_unit_uzs) * qty;
  const roi = net_profit_total / total_landed_cost_uzs;

  return {
    volume_per_unit_cbm: (l * ww * h) / 1000000,
    total_volume_cbm: (l * ww * h) * qty / 1000000,
    total_weight_kg: actual_weight,
    chargeable_weight_kg: chargeable_weight,
    cargo_cost_usd,
    cargo_cost_per_unit_usd: cargo_cost_usd / qty,
    customs_duty_pct: customs_rate * 100,
    customs_cost_usd,
    vat_usd,
    total_landed_cost_usd,
    total_landed_cost_uzs,
    cost_per_unit_uzs,
    uzum_sell_price_uzs: input.uzum_sell_price_uzs,
    gross_margin_pct: gross_margin * 100,
    net_margin_pct: gross_margin * 100,
    roi_pct: roi * 100,
    breakeven_units: Math.ceil(total_landed_cost_uzs / (revenue_per_unit - cost_per_unit_uzs)),
    payback_days: Math.ceil(qty / 10), // taxminiy
    verdict: gross_margin > 0.30 ? 'HIGHLY_PROFITABLE' :
             gross_margin > 0.15 ? 'PROFITABLE' :
             gross_margin > 0.05 ? 'BORDERLINE' : 'NOT_PROFITABLE',
    recommendation: generateCargoRecommendation(gross_margin, provider)
  };
}
```

#### DB
```sql
CREATE TABLE cargo_calculations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID REFERENCES accounts(id),
  product_id BIGINT REFERENCES products(id),
  origin VARCHAR(20),              -- CHINA | EUROPE
  cargo_provider VARCHAR(100),
  order_quantity INT,
  purchase_price_usd DECIMAL(12,2),
  total_landed_cost_usd DECIMAL(12,2),
  total_landed_cost_uzs BIGINT,
  cost_per_unit_uzs BIGINT,
  gross_margin_pct DECIMAL(6,2),
  roi_pct DECIMAL(8,2),
  verdict VARCHAR(30),
  full_result JSONB,               -- CargoResult to'liq
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE cargo_providers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  origin VARCHAR(20),
  transit_days INT,
  price_per_kg_usd DECIMAL(8,2),
  price_per_cbm_usd DECIMAL(8,2),
  min_weight_kg DECIMAL(8,2),
  notes TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
-- Admin orqali yangilanadi (narxlar o'zgaradi)
```

#### UI â€” "Manba Taqqoslagichi"
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mahsulot: Ğ¡Ğ²ĞµÑ‚Ğ¾ĞºĞ¾Ğ¿Ğ¸ Ğ4 (500 Ñ‚Ğ°)                           â”‚
â”‚  Uzum da sotish narxi: 46,990 ÑÑƒĞ¼                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚ ğŸ‡¨ğŸ‡³ 1688.com    â”‚ ğŸŒ Amazon.de         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Narx (dona)      â”‚ $0.85 (8,800 ÑÑƒĞ¼)â”‚ â‚¬2.10 (25,000 ÑÑƒĞ¼)  â”‚
â”‚ MOQ              â”‚ 50 ta            â”‚ 1 ta                  â”‚
â”‚ Cargo (Kargo EX) â”‚ $1.20/kg         â”‚ $3.50/kg             â”‚
â”‚ Bojxona          â”‚ 10%              â”‚ 10%                   â”‚
â”‚ QQS              â”‚ 12%              â”‚ 12%                   â”‚
â”‚ Tannarx (dona)   â”‚ 14,200 ÑÑƒĞ¼       â”‚ 37,500 ÑÑƒĞ¼           â”‚
â”‚ Gross margin     â”‚ 69.7% âœ…         â”‚ -20.2% âŒ            â”‚
â”‚ ROI              â”‚ 230% ğŸ”¥          â”‚ Zarar                 â”‚
â”‚ Yetkazish        â”‚ 18 kun           â”‚ 14 kun               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¡ Tavsiya: 1688.com dan olib keling (Kargo Ekspres yo'li) â”‚
â”‚    500 ta buyurtma: $710 cargo + $425 customs = $1,135     â”‚
â”‚    Sof foyda: ~15,700,000 ÑÑƒĞ¼ (1 partiyadan)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### API
```
POST /api/sourcing/compare
Body: {
  product_id: 18332,
  order_quantity: 500,
  weight_kg: 2.0,
  dimensions_cm: [30, 20, 10],
  uzum_sell_price: 46990
}
â†’ {
    china_sources: [{ source, price_usd, cargo_options: [CargoResult] }],
    europe_sources: [{ source, price_usd, cargo_options: [CargoResult] }],
    best_option: CargoResult,
    comparison_table: SourcingComparisonTable
  }

GET /api/cargo/providers        â†’ barcha kargo xizmatlar
PUT /api/admin/cargo/providers/:id â†’ narxlarni yangilash (admin only)

GET /api/currency/rates         â†’ joriy kurslar
```

#### Kargo narxlar admin paneli
```
Admin â†’ Kargo Xizmatlar â†’ narxlarni real vaqtda yangilash
Sotuvchi ko'rayotgan narxlar = admin belgilagan narxlar
```

---

## v4.0 DELIVERY CHECKLIST

```
âœ… Feature 31: Uzum Ads ROI Tracker
âœ… Feature 32: Telegram Mini App (grammY + WebApp)
âœ… Feature 36: Team Collaboration (RBAC)
âœ… Feature 37: Custom Report Builder (Puppeteer PDF)
âœ… Feature 38: Market Share PDF (oylik avtomatik)
âœ… Feature 39: Watchlist Sharing (public link)
âœ… Feature 40: Historical Data Archive (partition + S3)
âœ… Feature 41: Collective Intelligence (social proof)
âœ… Feature 42: Algorithm Reverse Engineering (correlation)
âœ… Feature 43: Xitoy/Evropa Narx Taqqoslash
âœ… Feature 43b: Cargo Kalkulyator (to'liq hisoblash)
```

---
*v4.0 | Features 31-43 | Faza 4+ uchun*